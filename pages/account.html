<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Личный кабинет - SvetSalonPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../images/logo.png">
    <link rel="shortcut icon" type="image/png" href="../images/logo.png">
    <script>
        // Глобальная переменная для Supabase
        let supabaseClient = null;
        
        // Функция загрузки Supabase SDK
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                // Пробуем загрузить с unpkg
                const script1 = document.createElement('script');
                script1.src = 'https://unpkg.com/@supabase/supabase-js@2';
                script1.onload = () => {
                    console.log('Supabase SDK загружен с unpkg');
                    // Ждем немного, чтобы SDK полностью инициализировался
                    setTimeout(() => {
                        if (typeof window.supabase !== 'undefined') {
                            console.log('Supabase SDK готов к использованию в window.supabase');
                            resolve();
                        } else if (typeof supabase !== 'undefined') {
                            console.log('Supabase SDK готов к использованию в глобальной переменной');
                            // Делаем доступным в window
                            window.supabase = supabase;
                            resolve();
                        } else {
                            reject(new Error('Supabase SDK загружен, но не инициализирован'));
                        }
                    }, 200);
                };
                script1.onerror = () => {
                    console.log('Ошибка загрузки с unpkg, пробуем cdn.jsdelivr.net');
                    
                    // Пробуем альтернативный источник
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script2.onload = () => {
                        console.log('Supabase SDK загружен с cdn.jsdelivr.net');
                        setTimeout(() => {
                            if (typeof window.supabase !== 'undefined') {
                                console.log('Supabase SDK готов к использованию в window.supabase');
                                resolve();
                            } else if (typeof supabase !== 'undefined') {
                                console.log('Supabase SDK готов к использованию в глобальной переменной');
                                window.supabase = supabase;
                                resolve();
                            } else {
                                reject(new Error('Supabase SDK загружен, но не инициализирован'));
                            }
                        }, 200);
                    };
                    script2.onerror = () => {
                        reject(new Error('Не удалось загрузить Supabase SDK'));
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }
        
        // Загружаем SDK при загрузке страницы
        window.addEventListener('load', async function() {
            try {
                await loadSupabase();
                console.log('Supabase SDK загружен успешно!');
                // Запускаем инициализацию
                if (typeof initSupabase === 'function') {
                    initSupabase();
                }
            } catch (error) {
                console.error('Ошибка загрузки Supabase:', error);
                showNotification('error', 'Ошибка загрузки', error.message);
            }
        });
    </script>
    <script src="../supabase-config.js"></script>
    <style>

        
        .nav-link:hover::after {
            content: '';
            display: block;
            width: 100%;
            height: 2px;
            background-color: #ec4899;
            margin-top: 2px;
        }

        /* Анимации для карточек услуг */
        .service-card {
            transition: all 0.3s ease;
            transform: translateY(0);
            position: relative;
        }
        
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(236, 72, 153, 0.1), 0 10px 10px -5px rgba(236, 72, 153, 0.04);
        }
        
        .service-card img {
            transition: transform 0.3s ease;
        }
        
        .service-card:hover img {
            transform: scale(1.05);
        }
        
        .service-card.selected {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border: 2px solid #ec4899;
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.2);
            transform: translateY(-4px);
        }
        
        .service-card.selected {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border: 2px solid #ec4899 !important;
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.2);
            transform: translateY(-4px);
        }
        
        .service-card.selected::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ec4899;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            animation: checkmarkAppear 0.3s ease-out;
        }
        
        @keyframes checkmarkAppear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Category card styles */
        .category-card {
            position: relative;
            overflow: hidden;
        }
        
        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Custom Notification Styles */
        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            margin-bottom: 8px;
            max-width: 400px;
            border-left: 4px solid;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        
        .notification.error {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .notification.info {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        
        /* iOS Style Mobile Menu */
        #sideMenu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60;
            pointer-events: none;
        }
        
        #sideMenu.open {
            pointer-events: all;
        }
        
        #sideMenu.open #menuBackdrop {
            opacity: 1;
            pointer-events: all;
            backdrop-filter: blur(2px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #sideMenu.open #menuContainer {
            transform: scale(1) translateX(0);
            opacity: 1;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #sideMenu:not(.open) #menuContainer {
            transform: scale(0.75) translateX(0) !important;
            opacity: 0 !important;
        }
        
        /* Prevent body scroll when menu is open */
        body.menu-open {
            overflow: hidden;
        }
        
        /* Menu Button Animation */
        .menu-icon-container {
            position: relative;
            width: 20px;
            height: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .menu-line {
            width: 100%;
            height: 2px;
            background-color: #374151;
            border-radius: 1px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        
        /* Menu Button Active State */
        #iosMenuBtn.active .menu-line:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }
        
        #iosMenuBtn.active .menu-line:nth-child(2) {
            opacity: 0;
            transform: scaleX(0);
        }
        
        #iosMenuBtn.active .menu-line:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }
        
        /* Hover effects for menu lines */
        #iosMenuBtn:hover .menu-line {
            background-color: #ec4899;
        }
        
        /* Menu Items */
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            text-decoration: none;
            color: #1f2937;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(236, 72, 153, 0.08);
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 16px;
            transform: scale(0.8);
        }
        
        .menu-item:hover::before {
            opacity: 1;
            transform: scale(1);
        }
        
        .menu-item:hover {
            transform: translateX(8px);
        }
        
        .menu-item:active::before {
            background: rgba(236, 72, 153, 0.12);
            transform: scale(1.05);
        }
        
        /* Menu Icons */
        .menu-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(236, 72, 153, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        
        .menu-icon i {
            font-size: 18px;
            color: #ec4899;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .menu-item:hover .menu-icon {
            background: rgba(236, 72, 153, 0.15);
            transform: scale(1.05);
        }
        
        .menu-item:active .menu-icon {
            transform: scale(0.98);
        }
        
        .menu-item:hover .menu-icon i {
            transform: scale(1.1);
        }
        
        .menu-item span {
            transition: all 0.3s ease;
        }
        
        .menu-item:hover span {
            transform: translateX(2px);
            color: #ec4899;
        }
        
        /* Bubble Animation */
        @keyframes bubblePop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .menu-item.bubble-animation::before {
            animation: bubblePop 0.2s ease-out;
        }
        
        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            background: #10b981;
            color: white;
        }
        
        .notification.error .notification-icon {
            background: #ef4444;
            color: white;
        }
        
        .notification.warning .notification-icon {
            background: #f59e0b;
            color: white;
        }
        
        .notification.info .notification-icon {
            background: #3b82f6;
            color: white;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }
        
        .notification-message {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s;
        }
        
        .notification-close:hover {
            color: #6b7280;
        }

        .form-input:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        /* Улучшенные стили для полей ввода */
        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: #ffffff;
        }
        
        .form-input:hover {
            border-color: #9ca3af;
        }
        
        /* Специальные стили для полей даты и времени */
        input[type="date"], input[type="time"], select {
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }
        
        input[type="date"]:focus, input[type="time"]:focus, select:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px 0 rgba(236,72,153,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(236, 72, 153, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px 0 rgba(236,72,153,0.15);
        }

        .auth-form {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(251, 207, 232, 0.1) 100%);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans bg-gradient-to-br from-pink-50 to-white text-gray-800 min-h-screen">
    <!-- Custom Notification System -->
    <div id="notificationContainer" class="fixed top-24 left-4 right-4 z-50 space-y-2 max-w-sm mx-auto"></div>
    <!-- Header -->
    <header class="fixed w-full bg-white shadow-sm z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="../index.html" class="logo-link">
                    <h1 class="text-2xl font-bold text-pink-600 hover:text-pink-700 transition-colors duration-200 cursor-pointer">SvetSalonPro</h1>
                </a>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="../index.html#home" class="nav-link text-gray-700 hover:text-pink-600 transition">Главная</a>
                <a href="../index.html#about" class="nav-link text-gray-700 hover:text-pink-600 transition">О нас</a>
                <a href="../index.html#services" class="nav-link text-gray-700 hover:text-pink-600 transition">Услуги</a>
                <a href="../index.html#masters" class="nav-link text-gray-700 hover:text-pink-600 transition">Мастера</a>
                <a href="../index.html#contact" class="nav-link text-gray-700 hover:text-pink-600 transition">Контакты</a>
                <a href="account.html" class="nav-link text-pink-600 font-semibold">Личный кабинет</a>
            </nav>
            <div class="flex items-center space-x-4">
                <!-- Admin Panel Button (Hidden by default) -->
                <button id="adminPanelBtn" class="hidden md:block text-gray-700 hover:text-red-600 transition-colors duration-200 bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg" style="display: none !important;">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-crown text-red-500"></i>
                        <span class="text-sm font-medium">Админ панель</span>
                    </div>
                </button>
                <!-- Mobile Admin Panel Button -->
                <button id="mobileAdminPanelBtn" class="md:hidden text-gray-700 hover:text-red-600 transition-colors duration-200 bg-red-50 hover:bg-red-100 px-2 py-2 rounded-lg" style="display: none !important;">
                    <i class="fas fa-crown text-red-500"></i>
                </button>
                <!-- iOS Style Menu Button -->
                <button id="iosMenuBtn" class="md:hidden text-gray-700 hover:text-pink-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 rounded-full">
                    <div class="w-12 h-12 bg-gray-100/50 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-gray-200/50 active:bg-gray-300/50 transition-all duration-200 transform hover:scale-105 active:scale-95">
                        <div class="menu-icon-container">
                            <span class="menu-line"></span>
                            <span class="menu-line"></span>
                            <span class="menu-line"></span>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- iOS Style Side Menu -->
    <div id="sideMenu" class="fixed inset-0 z-60 pointer-events-none">
        <!-- Backdrop -->
        <div id="menuBackdrop" class="absolute inset-0 bg-black/20 opacity-0 transition-all duration-250 ease-out pointer-events-none"></div>
        
        <!-- Menu Container -->
        <div id="menuContainer" class="absolute top-24 right-4 h-auto max-h-[80vh] w-72 bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl transform scale-75 opacity-0 transition-all duration-250 ease-out border border-white/30">
            <!-- Menu Header -->
            <div class="flex items-center justify-between p-3 border-b border-white/10">
                <div class="flex items-center space-x-2">
                    <img src="../images/logo.png" alt="SvetSalonPro" class="w-8 h-8 rounded-full">
                    <div>
                        <h2 class="text-base font-semibold text-gray-800">SvetSalonPro</h2>
                        <p class="text-xs text-gray-600">Салон красоты</p>
                    </div>
                </div>
                <button id="closeMenuBtn" class="w-8 h-8 rounded-full bg-gray-100/50 backdrop-blur-sm flex items-center justify-center hover:bg-gray-200/50 active:bg-gray-300/50 transition-all duration-200 transform hover:scale-105 active:scale-95 cursor-pointer">
                    <i class="fas fa-times text-gray-600 text-sm"></i>
                </button>
            </div>
            
            <!-- Menu Content -->
            <div class="flex-1 overflow-y-auto">
                <!-- Navigation Links -->
                <div class="p-2 space-y-0.5">
                    <a href="../index.html#home" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <span>Главная</span>
                    </a>
                    
                    <a href="../index.html#about" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <span>О нас</span>
                    </a>
                    
                    <a href="../index.html#services" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-spa"></i>
                        </div>
                        <span>Услуги</span>
                    </a>
                    
                    <a href="../index.html#masters" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <span>Мастера</span>
                    </a>
                    
                    <a href="../index.html#contact" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <span>Контакты</span>
                    </a>
                </div>
                
                <!-- Divider -->
                <div class="mx-4 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                
                <!-- Profile Section -->
                <div class="p-2">
                    <a href="account.html" class="menu-item group">
                        <div class="menu-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>Личный кабинет</span>
                    </a>
                </div>
                
                <!-- Contact Info -->
                <div class="p-2 mt-2">
                    <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-xl p-3 text-white">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-envelope text-sm"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">my@SvetSalonPro.ru</p>
                                <p class="text-xs text-pink-100">Пишите в любое время</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-phone text-sm"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">+7 928 280 62 94</p>
                                <p class="text-xs text-pink-100">Звоните с 9:00 до 21:00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </header>

    <!-- Main Content -->
    <main class="pt-32 pb-20">
        <div class="container mx-auto px-4">
            <!-- Auth Section -->
            <div id="authSection" class="max-w-md mx-auto mb-8 fade-in">
                <div class="card rounded-xl p-8 text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Вход в личный кабинет</h2>
                    
                    <!-- Login Form -->
                    <form id="loginForm" class="space-y-4">
                        <!-- Auth Method Toggle -->
                        <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
                            <button type="button" id="phoneAuthBtn" class="flex-1 py-2 px-4 rounded-md bg-pink-600 text-white font-medium transition-colors">
                                <i class="fas fa-mobile-alt mr-2"></i>Телефон
                            </button>
                            <button type="button" id="emailAuthBtn" class="flex-1 py-2 px-4 rounded-md text-gray-600 font-medium transition-colors hover:bg-white">
                                <i class="fas fa-envelope mr-2"></i>Email
                            </button>
                        </div>
                        
                        <!-- Phone Auth Section -->
                        <div id="phoneAuthSection">
                            <div>
                                <label for="phone" class="block text-gray-700 font-medium mb-2 text-left">Номер телефона</label>
                                <input type="tel" id="phone" name="phone" required 
                                       class="form-input w-full"
                                       placeholder="+7 (___) ___-__-__"
                                       maxlength="18">
                                <p class="text-sm text-gray-500 mt-1">Начните вводить номер, +7 добавится автоматически</p>
                            </div>
                            
                            <button type="submit" id="loginBtn" class="btn-primary w-full py-3 px-6 rounded-lg text-white font-semibold">
                                <span id="loginBtnText">Отправить код</span>
                                <span id="loginBtnLoading" class="loading hidden"></span>
                            </button>
                            
                            <div class="mt-4 text-sm text-gray-600">
                                <p>Мы отправим SMS-код для входа на ваш номер</p>
                            </div>
                        </div>
                        
                        <!-- Email Auth Section (Hidden by default) -->
                        <div id="emailAuthSection" class="hidden">
                            <div>
                                <label for="email" class="block text-gray-700 font-medium mb-2 text-left">Email</label>
                                <input type="email" id="email" name="email" 
                                       class="form-input w-full"
                                       placeholder="your@email.com">
                            </div>
                            
                            <button type="submit" id="emailLoginBtn" class="btn-primary w-full py-3 px-6 rounded-lg text-white font-semibold">
                                <span id="emailLoginBtnText">Отправить ссылку</span>
                                <span id="emailLoginBtnLoading" class="loading hidden"></span>
                            </button>
                            
                            <div class="mt-4 text-sm text-gray-600">
                                <p>Мы отправим ссылку для входа на ваш email</p>
                            </div>
                        </div>
                    </form>
                    
                    <!-- SMS Code Verification Modal -->
                    <div id="smsVerificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl max-w-md w-full p-6">
                            <div class="text-center">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Подтверждение номера</h3>
                                <p class="text-gray-600 mb-6">Введите код из SMS, отправленный на номер <span id="verificationPhone" class="font-semibold"></span></p>
                                
                                <form id="smsVerificationForm" class="space-y-4">
                                    <div>
                                        <label for="smsCode" class="block text-gray-700 font-medium mb-2">Код подтверждения</label>
                                        <input type="text" id="smsCode" name="smsCode" required 
                                               class="form-input w-full text-center text-2xl font-mono tracking-widest"
                                               placeholder="000000"
                                               maxlength="6"
                                               pattern="[0-9]{6}">
                                    </div>
                                    
                                    <div class="flex space-x-3">
                                        <button type="button" id="resendCodeBtn" class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                            <span id="resendCodeText">Отправить повторно</span>
                                            <span id="resendCodeTimer" class="hidden text-sm text-gray-500"></span>
                                        </button>
                                        <button type="submit" id="verifyCodeBtn" class="flex-1 btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                                            <span id="verifyCodeBtnText">Подтвердить</span>
                                            <span id="verifyCodeBtnLoading" class="loading hidden"></span>
                                        </button>
                                    </div>
                                </form>
                                
                                <button type="button" id="cancelVerificationBtn" class="mt-4 text-gray-500 hover:text-gray-700">
                                    Отмена
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="hidden max-w-4xl mx-auto fade-in">
                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Profile Info -->
                    <div class="md:col-span-1">
                        <div class="card rounded-xl p-6">
                            <div class="text-center mb-6">
                                <div class="w-24 h-24 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 overflow-hidden">
                                    <i class="fas fa-user text-3xl text-pink-600" id="mainProfileIcon"></i>
                                    <img id="mainProfileImage" class="w-full h-full object-cover hidden" alt="Фото профиля">
                                </div>
                                <h3 id="userName" class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-spinner fa-spin text-pink-600 mr-2"></i>Загрузка...
                                </h3>
                                <p id="userEmail" class="text-gray-600">loading@email.com</p>
                                <p id="userPhone" class="text-gray-600">+7 (___) ___-__-__</p>
                            </div>
                            
                            <button id="editProfileBtn" class="w-full py-2 px-4 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition mb-3">
                                Редактировать профиль
                            </button>
                            <button id="logoutBtn" class="w-full py-2 px-4 border border-pink-300 text-pink-600 rounded-lg hover:bg-pink-50 transition">
                                Выйти
                            </button>
                        </div>
                    </div>

                    <!-- Bookings -->
                    <div class="md:col-span-2">
                        <div class="card rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-semibold text-gray-800">Мои записи</h3>
                                <button id="newBookingBtn" class="btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                                    Новая запись
                                </button>
                            </div>
                            
                            <div id="bookingsList" class="space-y-4">
                                <!-- Bookings will be loaded here -->
                            </div>
                            
                            <div id="noBookings" class="hidden text-center py-12">
                                <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">У вас пока нет записей</p>
                                <button id="bookFirstBtn" class="btn-primary mt-4 py-2 px-6 rounded-lg text-white font-semibold">
                                    Записаться на услугу
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Booking Modal -->
            <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-semibold text-gray-800">Выберите категорию услуг</h3>
                            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Category Selection -->
                        <div id="categorySelection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- Hair Services Category -->
                            <div class="category-card bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-pink-200 hover:border-pink-300" data-category="hair">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-cut text-white text-2xl"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold mb-2 text-gray-800">Стрижки и уход за волосами</h4>
                                    <p class="text-gray-600">Женские и мужские стрижки, окрашивание, укладки</p>
                                </div>
                            </div>
                            
                            <!-- Manicure Services Category -->
                            <div class="category-card bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-purple-200 hover:border-purple-300" data-category="manicure">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-hand-sparkles text-white text-2xl"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold mb-2 text-gray-800">Маникюр и уход за ногтями</h4>
                                    <p class="text-gray-600">Классический, комбинированный маникюр, укрепление</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hair Services Grid (Hidden by default) -->
                        <div id="hairServicesGrid" class="hidden">
                            <div class="flex items-center mb-6">
                                <button id="backToCategoriesBtn" class="mr-4 text-pink-600 hover:text-pink-700">
                                    <i class="fas fa-arrow-left mr-2"></i>Назад к категориям
                                </button>
                                <h4 class="text-xl font-semibold text-gray-800">Стрижки и уход за волосами</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <!-- SPA процедуры -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="spa" data-price="800">
                                    <div class="text-center">
                                        <img src="../images/SPA процедуры.JPG" alt="SPA процедуры" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">SPA процедуры</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 800 ₽</p>
                                        <p class="text-gray-600 text-sm">Расслабляющие и оздоравливающие процедуры для волос и кожи головы.</p>
                                    </div>
                                </div>
                                
                                <!-- Женская стрижка -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="womens_haircut" data-price="700">
                                    <div class="text-center">
                                        <img src="../images/Женская стрижка.JPG" alt="Женская стрижка" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Женская стрижка</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 700 ₽</p>
                                        <p class="text-gray-600 text-sm">Современные женские стрижки любой сложности с учетом ваших пожеланий.</p>
                                    </div>
                                </div>
                                
                                <!-- Мужская стрижка -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="mens_haircut" data-price="700">
                                    <div class="text-center">
                                        <img src="../images/Мужская стрижка.JPG" alt="Мужская стрижка" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Мужская стрижка</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 700 ₽</p>
                                        <p class="text-gray-600 text-sm">Классические и современные мужские стрижки для любого стиля.</p>
                                    </div>
                                </div>
                                
                                <!-- Мужская стрижка под машинку -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="mens_machine" data-price="600">
                                    <div class="text-center">
                                        <img src="../images/Мужская стрижка под машинку.JPG" alt="Мужская стрижка под машинку" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Мужская стрижка под машинку</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 600 ₽</p>
                                        <p class="text-gray-600 text-sm">Быстрая и аккуратная стрижка под машинку для мужчин и детей.</p>
                                    </div>
                                </div>
                                
                                <!-- Окрашивание волос -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="coloring" data-price="800">
                                    <div class="text-center">
                                        <img src="../images/Окрашивание волос.JPG" alt="Окрашивание волос" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Окрашивание волос</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 800 ₽</p>
                                        <p class="text-gray-600 text-sm">Профессиональное окрашивание с использованием премиальных красок.</p>
                                    </div>
                                </div>
                                
                                <!-- Мелирование волос -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="highlighting" data-price="1200">
                                    <div class="text-center">
                                        <img src="../images/Мелирование волос.JPG" alt="Мелирование волос" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Мелирование волос</h4>
                                        <p class="text-pink-600 font-bold mb-2">1200 ₽</p>
                                        <p class="text-gray-600 text-sm">Мелирование для создания ярких и естественных акцентов в прическе.</p>
                                    </div>
                                </div>
                                
                                <!-- Ламинирование волос -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="lamination" data-price="1000">
                                    <div class="text-center">
                                        <img src="../images/Ламинирования волос.JPG" alt="Ламинирование волос" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Ламинирование волос</h4>
                                        <p class="text-pink-600 font-bold mb-2">1000 ₽</p>
                                        <p class="text-gray-600 text-sm">Процедура для гладкости, блеска и защиты волос от повреждений.</p>
                                    </div>
                                </div>
                                
                                <!-- Колористика волос -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="coloristics" data-price="2800">
                                    <div class="text-center">
                                        <img src="../images/Колористика волос.JPG" alt="Колористика волос" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Колористика волос</h4>
                                        <p class="text-pink-600 font-bold mb-2">от 2800 ₽</p>
                                        <p class="text-gray-600 text-sm">Сложные техники окрашивания и подбор идеального оттенка.</p>
                                    </div>
                                </div>
                                
                                <!-- Укрепление гелем -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="gel" data-price="1300">
                                    <div class="text-center">
                                        <img src="../images/Укрепление гелем 00.37.43.JPG" alt="Укрепление гелем" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Укрепление гелем</h4>
                                    <p class="text-pink-600 font-bold mb-2">1300 ₽</p>
                                    <p class="text-gray-600 text-sm">Укрепление и восстановление структуры ногтей с помощью геля.</p>
                                </div>
                            </div>
                            
                            <!-- Комбинированный маникюр -->
                            <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2" data-service="combined_manicure" data-price="1500">
                                <div class="text-center">
                                    <img src="../images/Комбинированный маникюр.jpg" alt="Комбинированный маникюр" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Комбинированный маникюр</h4>
                                    <p class="text-pink-600 font-bold mb-2">1500 ₽</p>
                                    <p class="text-gray-600 text-sm">Комбинированный маникюр с укреплением ногтевой пластины.</p>
                                </div>
                            </div>
                            
                            <!-- Классический маникюр -->
                            <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2" data-service="classic_manicure" data-price="700">
                                <div class="text-center">
                                    <img src="../images/Классический маникюр.png" alt="Классический маникюр" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Классический маникюр</h4>
                                    <p class="text-pink-600 font-bold mb-2">700 ₽</p>
                                    <p class="text-gray-600 text-sm">Классический маникюр с использованием профессиональных средств.</p>
                                </div>
                            </div>
                            
                            <!-- Ремонт одного ногтя -->
                            <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2" data-service="nail_repair" data-price="300">
                                <div class="text-center">
                                    <img src="../images/Ремонт одного ногтя.jpg" alt="Ремонт одного ногтя" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Ремонт одного ногтя</h4>
                                    <p class="text-pink-600 font-bold mb-2">300 ₽</p>
                                    <p class="text-gray-600 text-sm">Профессиональный ремонт поврежденного ногтя.</p>
                                </div>
                            </div>
                            
                            <!-- Укрепление базой или биогелем -->
                            <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2" data-service="base_strengthening" data-price="800">
                                <div class="text-center">
                                    <img src="../images/Укрепление_базой_или_биогелем_копия.jpeg" alt="Укрепление базой или биогелем" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Укрепление базой или биогелем</h4>
                                    <p class="text-pink-600 font-bold mb-2">800 ₽</p>
                                    <p class="text-gray-600 text-sm">Укрепление ногтей базой или биогелем для прочности.</p>
                                </div>
                            </div>
                            
                            <!-- Снятие покрытия -->
                            <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="coating_removal" data-price="400">
                                <div class="text-center">
                                    <img src="../images/Снятие покрытия.jpeg" alt="Снятие покрытия" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Снятие покрытия</h4>
                                    <p class="text-pink-600 font-bold mb-2">400 ₽</p>
                                    <p class="text-gray-600 text-sm">Безопасное снятие гель-лака и других покрытий.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manicure Services Grid (Hidden by default) -->
                        <div id="manicureServicesGrid" class="hidden">
                            <div class="flex items-center mb-6">
                                <button id="backToCategoriesBtn2" class="mr-4 text-purple-600 hover:text-purple-700">
                                    <i class="fas fa-arrow-left mr-2"></i>Назад к категориям
                                </button>
                                <h4 class="text-xl font-semibold text-gray-800">Маникюр и уход за ногтями</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <!-- Комбинированный маникюр -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="combined_manicure" data-price="1500">
                                    <div class="text-center">
                                        <img src="../images/Комбинированный маникюр.jpg" alt="Комбинированный маникюр" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Комбинированный маникюр</h4>
                                        <p class="text-purple-600 font-bold mb-2">1500 ₽</p>
                                        <p class="text-gray-600 text-sm">Комбинированный маникюр с укреплением ногтевой пластины.</p>
                                    </div>
                                </div>
                                
                                <!-- Классический маникюр -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="classic_manicure" data-price="700">
                                    <div class="text-center">
                                        <img src="../images/Классический маникюр.png" alt="Классический маникюр" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Классический маникюр</h4>
                                        <p class="text-purple-600 font-bold mb-2">700 ₽</p>
                                        <p class="text-gray-600 text-sm">Классический маникюр с использованием профессиональных средств.</p>
                                    </div>
                                </div>
                                
                                <!-- Ремонт одного ногтя -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="nail_repair" data-price="300">
                                    <div class="text-center">
                                        <img src="../images/Ремонт одного ногтя.jpg" alt="Ремонт одного ногтя" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Ремонт одного ногтя</h4>
                                        <p class="text-purple-600 font-bold mb-2">300 ₽</p>
                                        <p class="text-gray-600 text-sm">Профессиональный ремонт поврежденного ногтя.</p>
                                    </div>
                                </div>
                                
                                <!-- Укрепление базой или биогелем -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="base_strengthening" data-price="800">
                                    <div class="text-center">
                                        <img src="../images/Укрепление_базой_или_биогелем_копия.jpeg" alt="Укрепление базой или биогелем" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Укрепление базой или биогелем</h4>
                                        <p class="text-purple-600 font-bold mb-2">800 ₽</p>
                                        <p class="text-gray-600 text-sm">Укрепление ногтей базой или биогелем для прочности.</p>
                                    </div>
                                </div>
                                
                                <!-- Снятие покрытия -->
                                <div class="service-card bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent" data-service="coating_removal" data-price="400">
                                    <div class="text-center">
                                        <img src="../images/Снятие покрытия.jpeg" alt="Снятие покрытия" class="w-24 h-24 object-cover rounded-lg mx-auto mb-4">
                                        <h4 class="text-lg font-semibold mb-2">Снятие покрытия</h4>
                                        <p class="text-purple-600 font-bold mb-2">400 ₽</p>
                                        <p class="text-gray-600 text-sm">Безопасное снятие гель-лака и других покрытий.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Booking Form (hidden initially) -->
                        <div id="bookingFormContainer" class="hidden">
                            <div class="border-t pt-6">
                                <h4 class="text-lg font-semibold mb-4">Запись на <span id="selectedServiceName"></span></h4>
                                <form id="newBookingForm" class="space-y-4">
                                    <input type="hidden" id="selectedService" name="service">
                                    <input type="hidden" id="selectedServicePrice" name="price">
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="dateSelect" class="block text-gray-700 font-medium mb-2">Дата</label>
                                            <input type="date" id="dateSelect" name="date" required class="form-input w-full">
                                        </div>
                                        
                                        <div>
                                            <label for="timeSelect" class="block text-gray-700 font-medium mb-2">Время</label>
                                            <select id="timeSelect" name="time" required class="form-input w-full">
                                                <option value="">Выберите время</option>
                                                <option value="11:00">11:00</option>
                                                <option value="12:00">12:00</option>
                                                <option value="13:00">13:00</option>
                                                <option value="14:00">14:00</option>
                                                <option value="15:00">15:00</option>
                                                <option value="16:00">16:00</option>
                                                <option value="17:00">17:00</option>
                                                <option value="18:00">18:00</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="bookingPhone" class="block text-gray-700 font-medium mb-2">Номер телефона *</label>
                                        <input type="tel" id="bookingPhone" name="phone" required 
                                               placeholder="Введите номер телефона" 
                                               class="form-input w-full">
                                        <p class="text-sm text-gray-500 mt-1">Начните вводить номер, +7 добавится автоматически</p>
                                    </div>
                                    
                                    <div class="flex space-x-3 pt-4">
                                        <button type="button" id="backToServicesBtn" class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                            Назад к услугам
                                        </button>
                                        <button type="submit" class="flex-1 btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                                            Записаться
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Редактировать профиль</h3>
                    <button id="closeEditModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editProfileForm" class="space-y-4">
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <div id="profileImagePreview" class="w-24 h-24 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 overflow-hidden">
                                <i class="fas fa-user text-3xl text-pink-600" id="defaultProfileIcon"></i>
                                <img id="profileImage" class="w-full h-full object-cover hidden" alt="Фото профиля">
                            </div>
                            <button type="button" id="changePhotoBtn" class="absolute bottom-0 right-0 bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-pink-700 transition">
                                <i class="fas fa-camera text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label for="editFullName" class="block text-gray-700 font-medium mb-2">Имя</label>
                        <input type="text" id="editFullName" name="fullName" required 
                               class="form-input w-full" placeholder="Введите ваше имя">
                    </div>
                    
                    <div>
                        <label for="editPhone" class="block text-gray-700 font-medium mb-2">Телефон</label>
                        <input type="tel" id="editPhone" name="phone" 
                               class="form-input w-full" placeholder="+7 (___) ___-__-__">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelEditBtn" 
                                class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Отмена
                        </button>
                        <button type="submit" class="flex-1 btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Photo Selection Modal -->
    <div id="photoSelectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Выберите фото профиля</h3>
                    <button id="closePhotoModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="customPhotoUpload" class="block text-gray-700 font-medium mb-2">Загрузить свое фото</label>
                        <input type="file" id="customPhotoUpload" name="photo" accept="image/*" 
                               class="form-input w-full" onchange="handleCustomPhotoUpload(event)">
                        <p class="text-sm text-gray-500 mt-1">Поддерживаются форматы: JPG, PNG, WebP (макс. 5MB)</p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">Доступные изображения (аватары + иконки)</label>
                        <div id="standardPhotos" class="grid grid-cols-5 gap-3 max-h-80 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                            <!-- Available images will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelPhotoBtn" 
                                class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Отмена
                        </button>
                        <button type="button" id="savePhotoBtn" 
                                class="flex-1 py-2 px-4 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition">
                            Сохранить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Supabase configuration
        let supabase;
        let currentUser = null;

        // Custom Notification System
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-exclamation-triangle',
                warning: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };
            
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Анимация появления
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Автоматическое удаление
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, duration);
            }
        }

        // Проверка авторизации при загрузке страницы
        async function checkAuthOnLoad() {
            try {
                console.log('Checking authentication status on account page...');
                
                // Проверяем, есть ли сохраненный пользователь
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        console.log('Found saved user:', user.email);
                        
                        // Проверяем, не истек ли токен
                        const currentTime = Math.floor(Date.now() / 1000);
                        if (user.exp && user.exp < currentTime) {
                            console.log('Token expired, clearing user data');
                            localStorage.removeItem('currentUser');
                            localStorage.removeItem('selectedAvatar');
                            showAuth();
                            return;
                        }
                        
                        // Пользователь авторизован
                        currentUserEmail = user.email;
                        
                        // Проверяем административные привилегии
                        if (checkAdminPrivileges(currentUserEmail)) {
                            isAdmin = true;
                            toggleAdminButtons(true);
                            console.log('Admin privileges restored');
                        }
                        
                        // Отправляем событие о входе пользователя
                        window.dispatchEvent(new CustomEvent('userLoggedIn', { detail: user }));
                        
                    } catch (e) {
                        console.error('Error parsing saved user:', e);
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('selectedAvatar');
                        showAuth();
                    }
                } else {
                    console.log('No saved user found');
                    showAuth();
                }
            } catch (error) {
                console.error('Error checking authentication:', error);
                showAuth();
            }
        }

        // Initialize Supabase
        async function initSupabase() {
            try {
                console.log('=== НАЧАЛО ИНИЦИАЛИЗАЦИИ SUPABASE ===');
                
                // Проверяем авторизацию при загрузке страницы
                await checkAuthOnLoad();
                
                // Проверяем, что DOM загружен
                if (document.readyState !== 'complete') {
                    console.log('DOM еще не загружен, ждем...');
                    await new Promise(resolve => {
                        document.addEventListener('DOMContentLoaded', resolve);
                    });
                }
                
                // Проверяем, что Supabase SDK загружен
                console.log('Проверяем window.supabase:', typeof window.supabase);
                console.log('Проверяем глобальную переменную supabase:', typeof supabase);
                
                // Если SDK не найден, пробуем загрузить заново
                if (typeof window.supabase === 'undefined' && typeof supabase === 'undefined') {
                    console.log('SDK не найден, пробуем загрузить заново...');
                    await loadSupabase();
                    
                    // Проверяем снова
                    console.log('После повторной загрузки:');
                    console.log('- window.supabase:', typeof window.supabase);
                    console.log('- supabase:', typeof supabase);
                    
                    if (typeof window.supabase === 'undefined' && typeof supabase === 'undefined') {
                        throw new Error('Supabase SDK не загружен даже после повторной попытки');
                    }
                }
                
                // Используем доступный SDK
                const sdk = window.supabase || supabase;
                console.log('Используем SDK:', sdk);
                
                // Создаем клиент
                console.log('Создаем клиент Supabase...');
                const client = sdk.createClient(
                    'https://iaezefurqmmgubdgqakt.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhZXplZnVycW1tZ3ViZGdxYWt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTk3NjQsImV4cCI6MjA3MTUzNTc2NH0.-Puoiddwu_xIx9BaHM0BBfbsULdU0Ljzh6uQleVToBQ'
                );
                
                console.log('Клиент создан:', client);
                
                // Присваиваем глобальным переменным
                window.supabaseClient = client;
                supabaseClient = client;
                
                console.log('Глобальные переменные установлены:');
                console.log('- window.supabaseClient:', window.supabaseClient);
                console.log('- supabaseClient:', supabaseClient);
                
                // Check if user is already logged in
                console.log('Проверяем текущего пользователя...');
                const { data: { user } } = await client.auth.getUser();
                if (user) {
                    console.log('Пользователь найден:', user);
                    currentUser = user;
                    
                    // Сохраняем пользователя в localStorage
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    // Отправляем событие о входе пользователя
                    window.dispatchEvent(new CustomEvent('userLoggedIn', { detail: user }));
                    
                    showProfile();
                    // Сразу показываем данные из currentUser
                    showUserDataImmediately(user);
                    // Затем загружаем полный профиль из базы данных
                    loadUserProfile();
                    // loadBookings(); // Временно отключено
                } else {
                    console.log('Пользователь не найден, показываем форму входа');
                    showAuth();
                }
                
                // Проверяем сессию в URL (для Magic Link)
                const { data: { session } } = await client.auth.getSession();
                if (session) {
                    console.log('Сессия найдена в URL:', session);
                    currentUser = session.user;
                    
                    // Сохраняем пользователя в localStorage
                    localStorage.setItem('currentUser', JSON.stringify(session.user));
                    
                    // Отправляем событие о входе пользователя
                    window.dispatchEvent(new CustomEvent('userLoggedIn', { detail: session.user }));
                    
                    showProfile();
                    // Сразу показываем данные из currentUser
                    showUserDataImmediately(session.user);
                    // Затем загружаем полный профиль из базы данных
                    loadUserProfile();
                    // loadBookings(); // Временно отключено
                }
                
                console.log('=== ИНИЦИАЛИЗАЦИЯ SUPABASE ЗАВЕРШЕНА УСПЕШНО ===');
                
                // Настраиваем форму входа
                console.log('Настраиваем форму входа...');
                setupLoginForm();
                
                // Настраиваем обработчик изменения состояния аутентификации
                console.log('Настраиваем обработчик аутентификации...');
                setupAuthStateChange();
                
            } catch (error) {
                console.error('=== ОШИБКА ИНИЦИАЛИЗАЦИИ SUPABASE ===');
                console.error('Error initializing Supabase:', error);
                console.error('Stack trace:', error.stack);
                showNotification('error', 'Ошибка инициализации', error.message);
            }
        }



        // Handle login form submission
        function setupLoginForm() {
            console.log('Настраиваем форму входа...');
            
            // Переключение между методами авторизации
            const phoneAuthBtn = document.getElementById('phoneAuthBtn');
            const emailAuthBtn = document.getElementById('emailAuthBtn');
            const phoneAuthSection = document.getElementById('phoneAuthSection');
            const emailAuthSection = document.getElementById('emailAuthSection');
            
            if (phoneAuthBtn && emailAuthBtn) {
                phoneAuthBtn.addEventListener('click', () => {
                    phoneAuthBtn.classList.add('bg-pink-600', 'text-white');
                    phoneAuthBtn.classList.remove('text-gray-600', 'hover:bg-white');
                    emailAuthBtn.classList.remove('bg-pink-600', 'text-white');
                    emailAuthBtn.classList.add('text-gray-600', 'hover:bg-white');
                    phoneAuthSection.classList.remove('hidden');
                    emailAuthSection.classList.add('hidden');
                });
                
                emailAuthBtn.addEventListener('click', () => {
                    emailAuthBtn.classList.add('bg-pink-600', 'text-white');
                    emailAuthBtn.classList.remove('text-gray-600', 'hover:bg-white');
                    phoneAuthBtn.classList.remove('bg-pink-600', 'text-white');
                    phoneAuthBtn.classList.add('text-gray-600', 'hover:bg-white');
                    emailAuthSection.classList.remove('hidden');
                    phoneAuthSection.classList.add('hidden');
                });
            }
            
            // Форматирование номера телефона
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length === 0) {
                        e.target.value = '';
                        return;
                    }
                    
                    if (value.length === 1 && value[0] === '7') {
                        value = value.substring(1);
                    }
                    
                    if (value.length > 0) {
                        value = '+7 (' + value;
                        if (value.length > 6) {
                            value = value.substring(0, 6) + ') ' + value.substring(6);
                        }
                        if (value.length > 11) {
                            value = value.substring(0, 11) + '-' + value.substring(11);
                        }
                        if (value.length > 14) {
                            value = value.substring(0, 14) + '-' + value.substring(14);
                        }
                        if (value.length > 17) {
                            value = value.substring(0, 17) + '-' + value.substring(17);
                        }
                    }
                    
                    e.target.value = value;
                });
            }
            
            // Обработка отправки формы (телефон)
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Форма отправлена!');
                    
                    const phoneInput = document.getElementById('phone');
                    const emailInput = document.getElementById('email');
                    const phoneAuthSection = document.getElementById('phoneAuthSection');
                    
                    // Определяем, какой метод авторизации активен
                    const isPhoneAuth = !phoneAuthSection.classList.contains('hidden');
                    
                    if (isPhoneAuth) {
                        await handlePhoneAuth(phoneInput.value);
                    } else {
                        await handleEmailAuth(emailInput.value);
                    }
                });
            }
            
            // Обработка верификации SMS
            const smsVerificationForm = document.getElementById('smsVerificationForm');
            if (smsVerificationForm) {
                smsVerificationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleSMSVerification();
                });
            }
            
            // Обработка повторной отправки кода
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            if (resendCodeBtn) {
                resendCodeBtn.addEventListener('click', async () => {
                    await handleResendCode();
                });
            }
            
            // Обработка отмены верификации
            const cancelVerificationBtn = document.getElementById('cancelVerificationBtn');
            if (cancelVerificationBtn) {
                cancelVerificationBtn.addEventListener('click', () => {
                    closeSMSVerificationModal();
                });
            }
            
            console.log('Форма входа настроена успешно!');
        }
        
        // Обработка телефонной авторизации
        async function handlePhoneAuth(phone) {
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');
            
            try {
                // Проверяем, что Supabase инициализирован
                const client = window.supabaseClient || supabaseClient;
                if (!client || !client.auth) {
                    throw new Error('Supabase не инициализирован. Попробуйте обновить страницу.');
                }
                
                // Форматируем номер телефона
                const formattedPhone = formatPhoneForAuth(phone);
                if (!formattedPhone) {
                    throw new Error('Введите корректный номер телефона');
                }
                
                console.log('Отправляем SMS на номер:', formattedPhone);
                
                // Show loading state
                loginBtn.disabled = true;
                loginBtnText.classList.add('hidden');
                loginBtnLoading.classList.remove('hidden');
                
                // Send SMS OTP
                const { error } = await client.auth.signInWithOtp({
                    phone: formattedPhone,
                    options: {
                        shouldCreateUser: true // Создаем пользователя, если его нет
                    }
                });
                
                if (error) throw error;
                
                // Show SMS verification modal
                showSMSVerificationModal(formattedPhone);
                
                // Show success message
                showNotification('success', 'Код отправлен!', 'SMS-код отправлен на ваш номер телефона');
                
            } catch (error) {
                console.error('Phone auth error:', error);
                showNotification('error', 'Ошибка отправки SMS', error.message);
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginBtnLoading.classList.add('hidden');
            }
        }
        
        // Обработка email авторизации
        async function handleEmailAuth(email) {
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            const emailLoginBtnText = document.getElementById('emailLoginBtnText');
            const emailLoginBtnLoading = document.getElementById('emailLoginBtnLoading');
            
            try {
                // Проверяем, что Supabase инициализирован
                const client = window.supabaseClient || supabaseClient;
                if (!client || !client.auth) {
                    throw new Error('Supabase не инициализирован. Попробуйте обновить страницу.');
                }
                
                console.log('Отправляем magic link на email:', email);
                
                // Show loading state
                emailLoginBtn.disabled = true;
                emailLoginBtnText.classList.add('hidden');
                emailLoginBtnLoading.classList.remove('hidden');
                
                // Send magic link
                const { error } = await client.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: 'https://svetsalonpro.ru/pages/account.html'
                    }
                });
                
                if (error) throw error;
                
                // Show success message
                showNotification('success', 'Ссылка отправлена!', 'Ссылка для входа отправлена на ваш email!');
                
            } catch (error) {
                console.error('Email auth error:', error);
                showNotification('error', 'Ошибка отправки email', error.message);
            } finally {
                // Reset button state
                emailLoginBtn.disabled = false;
                emailLoginBtnText.classList.remove('hidden');
                emailLoginBtnLoading.classList.add('hidden');
            }
        }
        
        // Форматирование номера телефона для авторизации
        function formatPhoneForAuth(phone) {
            // Убираем все символы кроме цифр
            const digits = phone.replace(/\D/g, '');
            
            // Проверяем длину (должно быть 10 цифр для России)
            if (digits.length !== 10) {
                return null;
            }
            
            // Возвращаем в формате +7XXXXXXXXXX
            return '+7' + digits;
        }
        
        // Показать модальное окно верификации SMS
        function showSMSVerificationModal(phone) {
            const modal = document.getElementById('smsVerificationModal');
            const verificationPhone = document.getElementById('verificationPhone');
            const smsCodeInput = document.getElementById('smsCode');
            
            if (modal && verificationPhone && smsCodeInput) {
                verificationPhone.textContent = phone;
                modal.classList.remove('hidden');
                smsCodeInput.focus();
                
                // Запускаем таймер для повторной отправки
                startResendTimer();
            }
        }
        
        // Закрыть модальное окно верификации SMS
        function closeSMSVerificationModal() {
            const modal = document.getElementById('smsVerificationModal');
            const smsCodeInput = document.getElementById('smsCode');
            
            if (modal) {
                modal.classList.add('hidden');
            }
            
            if (smsCodeInput) {
                smsCodeInput.value = '';
            }
            
            // Останавливаем таймер
            stopResendTimer();
        }
        
        // Обработка верификации SMS
        async function handleSMSVerification() {
            const verifyCodeBtn = document.getElementById('verifyCodeBtn');
            const verifyCodeBtnText = document.getElementById('verifyCodeBtnText');
            const verifyCodeBtnLoading = document.getElementById('verifyCodeBtnLoading');
            const smsCodeInput = document.getElementById('smsCode');
            
            try {
                const code = smsCodeInput.value.trim();
                if (!code || code.length !== 6) {
                    throw new Error('Введите 6-значный код из SMS');
                }
                
                // Show loading state
                verifyCodeBtn.disabled = true;
                verifyCodeBtnText.classList.add('hidden');
                verifyCodeBtnLoading.classList.remove('hidden');
                
                // Verify SMS code
                const client = window.supabaseClient || supabaseClient;
                const { data, error } = await client.auth.verifyOtp({
                    phone: document.getElementById('verificationPhone').textContent,
                    token: code,
                    type: 'sms'
                });
                
                if (error) throw error;
                
                // Success - user is now authenticated
                console.log('SMS verification successful:', data);
                closeSMSVerificationModal();
                showNotification('success', 'Успешная авторизация!', 'Добро пожаловать в личный кабинет!');
                
            } catch (error) {
                console.error('SMS verification error:', error);
                showNotification('error', 'Ошибка верификации', error.message);
            } finally {
                // Reset button state
                verifyCodeBtn.disabled = false;
                verifyCodeBtnText.classList.remove('hidden');
                verifyCodeBtnLoading.classList.add('hidden');
            }
        }
        
        // Обработка повторной отправки кода
        async function handleResendCode() {
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            const resendCodeText = document.getElementById('resendCodeText');
            const resendCodeTimer = document.getElementById('resendCodeTimer');
            
            try {
                const phone = document.getElementById('verificationPhone').textContent;
                
                // Show loading state
                resendCodeBtn.disabled = true;
                resendCodeText.textContent = 'Отправка...';
                
                // Resend SMS
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client.auth.signInWithOtp({
                    phone: phone,
                    options: {
                        shouldCreateUser: true
                    }
                });
                
                if (error) throw error;
                
                // Show success message
                showNotification('success', 'Код отправлен!', 'Новый SMS-код отправлен на ваш номер');
                
                // Start timer
                startResendTimer();
                
            } catch (error) {
                console.error('Resend code error:', error);
                showNotification('error', 'Ошибка отправки', error.message);
            } finally {
                // Reset button state
                resendCodeBtn.disabled = false;
                resendCodeText.textContent = 'Отправить повторно';
            }
        }
        
        // Таймер для повторной отправки кода
        let resendTimer = null;
        let resendCountdown = 60;
        
        function startResendTimer() {
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            const resendCodeText = document.getElementById('resendCodeText');
            const resendCodeTimer = document.getElementById('resendCodeTimer');
            
            if (!resendCodeBtn || !resendCodeText || !resendCodeTimer) return;
            
            resendCountdown = 60;
            resendCodeBtn.disabled = true;
            resendCodeText.classList.add('hidden');
            resendCodeTimer.classList.remove('hidden');
            
            resendTimer = setInterval(() => {
                resendCountdown--;
                resendCodeTimer.textContent = `Повторить через ${resendCountdown}с`;
                
                if (resendCountdown <= 0) {
                    stopResendTimer();
                }
            }, 1000);
        }
        
        function stopResendTimer() {
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            const resendCodeText = document.getElementById('resendCodeText');
            const resendCodeTimer = document.getElementById('resendCodeTimer');
            
            if (resendTimer) {
                clearInterval(resendTimer);
                resendTimer = null;
            }
            
            if (resendCodeBtn && resendCodeText && resendCodeTimer) {
                resendCodeBtn.disabled = false;
                resendCodeText.classList.remove('hidden');
                resendCodeTimer.classList.add('hidden');
            }
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const client = window.supabaseClient || supabaseClient;
                await client.auth.signOut();
                currentUser = null;
                
                // Очищаем данные профиля из localStorage
                localStorage.removeItem('currentUser');
                localStorage.removeItem('selectedAvatar');
                
                // Сбрасываем кнопки администратора
                toggleAdminButtons(false);
                
                // Отправляем событие о выходе пользователя
                window.dispatchEvent(new CustomEvent('userLoggedOut'));
                
                showAuth();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Show auth section
        function showAuth() {
            try {
                const authSection = document.getElementById('authSection');
                const profileSection = document.getElementById('profileSection');
                
                if (!authSection || !profileSection) {
                    console.error('Не найдены секции auth или profile');
                    return;
                }
                
                authSection.classList.remove('hidden');
                profileSection.classList.add('hidden');
                console.log('Форма входа показана успешно');
            } catch (error) {
                console.error('Ошибка при показе формы входа:', error);
            }
        }

        // Show profile section
        function showProfile() {
            try {
                const authSection = document.getElementById('authSection');
                const profileSection = document.getElementById('profileSection');
                
                if (!authSection || !profileSection) {
                    console.error('Не найдены секции auth или profile');
                    return;
                }
                
                authSection.classList.add('hidden');
                profileSection.classList.remove('hidden');
                console.log('Профиль показан успешно');
            } catch (error) {
                console.error('Ошибка при показе профиля:', error);
            }
        }

        // Показать данные пользователя сразу (без задержки)
        function showUserDataImmediately(user) {
            console.log('Показываем данные пользователя сразу:', user);
            
            // Показываем данные из user_metadata или email
            const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'Пользователь';
            const userEmail = user.email || 'loading@email.com';
            const userPhone = user.phone || user.user_metadata?.phone || 'Не указан';
            
            // Обновляем UI с анимацией
            const nameElement = document.getElementById('userName');
            const emailElement = document.getElementById('userEmail');
            const phoneElement = document.getElementById('userPhone');
            
            if (nameElement) {
                nameElement.style.opacity = '0';
                nameElement.innerHTML = userName; // Убираем спиннер
                setTimeout(() => {
                    nameElement.style.transition = 'opacity 0.3s ease-in-out';
                    nameElement.style.opacity = '1';
                }, 50);
            }
            
            if (emailElement) {
                emailElement.style.opacity = '0';
                emailElement.textContent = userEmail;
                setTimeout(() => {
                    emailElement.style.transition = 'opacity 0.3s ease-in-out';
                    emailElement.style.opacity = '1';
                }, 100);
            }
            
            if (phoneElement) {
                phoneElement.style.opacity = '0';
                phoneElement.textContent = userPhone;
                setTimeout(() => {
                    phoneElement.style.transition = 'opacity 0.3s ease-in-out';
                    phoneElement.style.opacity = '1';
                }, 150);
            }
            
            // Восстанавливаем аватарку
            restoreSelectedAvatar();
        }

        // Load user profile
        async function loadUserProfile() {
            if (!currentUser) {
                console.log('Нет текущего пользователя для загрузки профиля');
                return;
            }
            
            try {
                console.log('Загружаем профиль для пользователя:', currentUser.id);
                const client = window.supabaseClient || supabaseClient;
                
                if (!client) {
                    throw new Error('Supabase клиент не инициализирован');
                }
                
                const { data: profile, error } = await client
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (profile) {
                    console.log('Профиль найден:', profile);
                    // Обновляем только если данные из базы лучше
                    const nameElement = document.getElementById('userName');
                    const emailElement = document.getElementById('userEmail');
                    const phoneElement = document.getElementById('userPhone');
                    
                    if (nameElement && profile.full_name) {
                        nameElement.textContent = profile.full_name;
                    }
                    if (emailElement && profile.email) {
                        emailElement.textContent = profile.email;
                    }
                    if (phoneElement && profile.phone) {
                        phoneElement.textContent = profile.phone;
                    }
                } else {
                    console.log('Профиль не найден, создаем новый');
                    // Create profile if doesn't exist
                    await createUserProfile();
                }
                
                // Восстанавливаем выбранную аватарку
                restoreSelectedAvatar();
                
            } catch (error) {
                console.error('Error loading profile:', error);
                // Показываем базовую информацию пользователя
                document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || 'Пользователь';
                document.getElementById('userEmail').textContent = currentUser.email || 'loading@email.com';
                document.getElementById('userPhone').textContent = 'Не указан';
                showNotification('warning', 'Внимание', 'Не удалось загрузить полный профиль, но вы можете продолжить работу');
                
                // Восстанавливаем выбранную аватарку даже при ошибке
                restoreSelectedAvatar();
            }
        }
        
        // Restore selected avatar from localStorage
        function restoreSelectedAvatar() {
            try {
                const savedAvatar = localStorage.getItem('selectedAvatar');
                if (!savedAvatar) return;
                
                console.log('Восстанавливаем аватарку:', savedAvatar);
                
                const profileImage = document.getElementById('profileImage');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                
                if (!profileImage || !defaultIcon) return;
                
                if (savedAvatar.startsWith('icon-')) {
                    // Это иконка
                    profileImage.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                    
                    const iconIndex = parseInt(savedAvatar.split('-')[1]);
                    const iconClasses = [
                        'fas fa-user', 'fas fa-user-tie', 'fas fa-user-graduate', 'fas fa-user-ninja',
                        'fas fa-user-astronaut', 'fas fa-user-cowboy', 'fas fa-user-doctor', 'fas fa-user-nurse',
                        'fas fa-user-secret', 'fas fa-user-tag', 'fas fa-user-check', 'fas fa-user-clock',
                        'fas fa-heart', 'fas fa-star', 'fas fa-crown', 'fas fa-gem', 'fas fa-sparkles',
                        'fas fa-fire', 'fas fa-leaf', 'fas fa-sun', 'fas fa-moon', 'fas fa-cloud',
                        'fas fa-flower', 'fas fa-butterfly'
                    ];
                    const iconColors = [
                        'text-pink-600', 'text-blue-600', 'text-green-600', 'text-purple-600',
                        'text-indigo-600', 'text-yellow-600', 'text-red-600', 'text-teal-600',
                        'text-gray-600', 'text-orange-600', 'text-emerald-600', 'text-cyan-600',
                        'text-rose-600', 'text-amber-600', 'text-yellow-600', 'text-violet-600',
                        'text-sky-600', 'text-orange-600', 'text-green-600', 'text-yellow-600',
                        'text-indigo-600', 'text-blue-600', 'text-pink-600', 'text-purple-600'
                    ];
                    
                    if (iconIndex < iconClasses.length) {
                        defaultIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                    }
                    
                    // Обновляем основное фото профиля
                    const mainProfileImage = document.getElementById('mainProfileImage');
                    const mainProfileIcon = document.getElementById('mainProfileIcon');
                    
                    if (mainProfileImage) mainProfileImage.classList.add('hidden');
                    if (mainProfileIcon) {
                        mainProfileIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                        mainProfileIcon.classList.remove('hidden');
                    }
                    
                } else {
                    // Это изображение (data URL или путь к файлу)
                    profileImage.src = savedAvatar;
                    profileImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    
                    // Обновляем основное фото профиля
                    const mainProfileImage = document.getElementById('mainProfileImage');
                    const mainProfileIcon = document.getElementById('mainProfileIcon');
                    
                    if (mainProfileImage) {
                        mainProfileImage.src = savedAvatar;
                        mainProfileImage.classList.remove('hidden');
                    }
                    if (mainProfileIcon) {
                        mainProfileIcon.classList.add('hidden');
                    }
                }
                
                console.log('Аватарка восстановлена успешно');
                
            } catch (error) {
                console.error('Error restoring avatar:', error);
            }
        }

        // Create user profile
        async function createUserProfile() {
            try {
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client
                    .from('profiles')
                    .insert({
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: currentUser.user_metadata?.full_name || 'Пользователь',
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Reload profile
                loadUserProfile();
            } catch (error) {
                console.error('Error creating profile:', error);
            }
        }

        // Load user bookings
        async function loadBookings() {
            if (!currentUser) {
                console.log('Нет текущего пользователя для загрузки записей');
                return;
            }
            
            try {
                console.log('Загружаем записи для пользователя:', currentUser.id);
                const client = window.supabaseClient || supabaseClient;
                
                if (!client) {
                    throw new Error('Supabase клиент не инициализирован');
                }
                
                const { data: bookings, error } = await client
                    .from('bookings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Записи загружены:', bookings);
                displayBookings(bookings || []);
            } catch (error) {
                console.error('Error loading bookings:', error);
                // Показываем пустой список записей
                displayBookings([]);
                showNotification('warning', 'Внимание', 'Не удалось загрузить записи, но вы можете создать новые');
            }
        }

        // Display bookings
        function displayBookings(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            const noBookings = document.getElementById('noBookings');
            
            if (bookings.length === 0) {
                bookingsList.classList.add('hidden');
                noBookings.classList.remove('hidden');
                return;
            }
            
            bookingsList.classList.remove('hidden');
            noBookings.classList.add('hidden');
            
            bookingsList.innerHTML = bookings.map(booking => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${booking.service_name || booking.services?.name || 'Услуга'}</h4>
                            <p class="text-gray-600 text-sm">${new Date(booking.date || booking.slots?.date).toLocaleDateString('ru-RU')} в ${booking.time || booking.slots?.time}</p>
                            <p class="text-gray-500 text-sm">Статус: ${getStatusText(booking.status)}</p>
                            <p class="text-pink-600 text-sm font-medium">${booking.price} ₽</p>
                        </div>
                        <div class="flex space-x-2">
                            ${booking.status === 'confirmed' ? `
                                <button onclick="cancelBooking('${booking.id}')" 
                                        class="px-3 py-1 text-sm border border-red-300 text-red-600 rounded hover:bg-red-50 transition">
                                    Отменить
                                </button>
                                <button onclick="rescheduleBooking('${booking.id}')" 
                                        class="px-3 py-1 text-sm border border-blue-300 text-blue-600 rounded hover:bg-blue-50 transition">
                                    Перенести
                                </button>
                            ` : ''}
                            ${booking.status === 'pending' ? `
                                <span class="px-3 py-1 text-sm bg-yellow-100 text-yellow-800 rounded">
                                    Ожидает подтверждения
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get status text
        function getStatusText(status) {
            const statuses = {
                'pending': 'Ожидает подтверждения',
                'confirmed': 'Подтверждено',
                'cancelled': 'Отменено',
                'completed': 'Завершено'
            };
            return statuses[status] || status;
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Вы уверены, что хотите отменить запись?')) return;
            
            try {
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client
                    .from('bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', bookingId);
                
                if (error) throw error;
                
                showNotification('success', 'Запись отменена', 'Запись успешно отменена');
                // loadBookings(); // Перезагружаем список записей (временно отключено)
            } catch (error) {
                console.error('Error cancelling booking:', error);
                showNotification('error', 'Ошибка', 'Не удалось отменить запись');
            }
        }

        // Reschedule booking
        function rescheduleBooking(bookingId) {
            showNotification('info', 'Информация', 'Функция переноса записи будет доступна в ближайшее время');
        }



        // Словарь для перевода услуг на русский
        const serviceTranslations = {
            'spa': 'SPA процедуры',
            'womens_haircut': 'Женская стрижка',
            'mens_haircut': 'Мужская стрижка',
            'mens_machine': 'Мужская стрижка под машинку',
            'hair_coloring': 'Окрашивание волос',
            'hair_highlighting': 'Мелирование волос',
            'lamination': 'Ламинирование волос',
            'coloristics': 'Колористика волос',
            'gel': 'Укрепление гелем',
            'combined_manicure': 'Комбинированный маникюр',
            'classic_manicure': 'Классический маникюр',
            'nail_repair': 'Ремонт одного ногтя',
            'base_strengthening': 'Укрепление базой или биогелем',
            'coating_removal': 'Снятие покрытия'
        };

        // Handle new booking form
        document.getElementById('newBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Форма отправлена');
            
            const formData = new FormData(e.target);
            const service = formData.get('service');
            const price = formData.get('price');
            const date = formData.get('date');
            const time = formData.get('time');
            const phone = formData.get('phone');
            
            console.log('Данные формы:', { service, price, date, time, phone });
            console.log('Текущий пользователь:', currentUser);
            
            try {
                const client = window.supabaseClient || supabaseClient;
                
                // Получаем данные пользователя
                const userName = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'Пользователь';
                const userPhone = phone || currentUser.phone || currentUser.user_metadata?.phone || 'Не указан';
                const serviceName = serviceTranslations[service] || service;
                
                // Пока что пропускаем сохранение в базу данных, чтобы проверить отправку в Telegram
                console.log('Создание записи:', {
                    user_id: currentUser.id,
                    service: service,
                    service_name: serviceName,
                    price: price,
                    date: date,
                    time: time
                });
                
                // Отправляем уведомление в Telegram
                const isRegistered = currentUser.email ? '💎 Зарегистрированный пользователь' : '👤 Гость';
                const message = `💬 Новая запись через личный кабинет:\n${isRegistered}\n👤 Имя: ${userName}\n📱 Телефон: ${userPhone}\n📋 Услуга: ${serviceName}\n💰 Цена: ${price} ₽\n📅 Дата: ${date}\n🕐 Время: ${time}`;
                
                const chatIds = ["339033504", "1366208620"]; // основной ID и ID Светланы
                
                console.log('Отправка в Telegram:', message);
                
                chatIds.forEach(chatId => {
                    fetch("https://api.telegram.org/bot7811248285:AAHfspwV_mA-PF298Bac28LBkEeehX_ql70/sendMessage", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: message
                        })
                    }).then(response => {
                        console.log('Telegram response:', response.status, response.statusText);
                        return response.json();
                    }).then(data => {
                        console.log('Telegram data:', data);
                        if (data.ok) {
                            if (chatId === "339033504") {
                                showNotification('success', 'Запись отправлена!', 'Ожидайте подтверждения от администратора.');
                                document.getElementById('bookingModal').classList.add('hidden');
                                e.target.reset();
                                // Сбрасываем форму и показываем сетку услуг
                                document.querySelector('.grid').style.display = 'grid';
                                document.getElementById('bookingFormContainer').classList.add('hidden');
                                
                                // Перезагружаем список записей (пока отключено)
                                // loadBookings();
                            }
                        } else {
                            if (chatId === "339033504") {
                                console.error('Telegram error:', data);
                                showNotification('error', 'Ошибка отправки', `Ошибка: ${data.description || 'Неизвестная ошибка'}`);
                            }
                        }
                    }).catch(error => {
                        console.error('Telegram fetch error:', error);
                        if (chatId === "339033504") {
                            showNotification('error', 'Ошибка соединения', 'Проверьте интернет');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error creating booking:', error);
                showNotification('error', 'Ошибка создания записи', error.message || 'Неизвестная ошибка');
            }
        });

        // Initialize date and time inputs
        function initializeDateTimeInputs() {
            const dateInput = document.getElementById('dateSelect');
            const timeSelect = document.getElementById('timeSelect');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Generate time slots
            const timeSlots = [];
            for (let hour = 9; hour <= 20; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                if (hour < 20) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
            }
            
            timeSelect.innerHTML = '<option value="">Выберите время</option>' +
                timeSlots.map(time => `<option value="${time}">${time}</option>`).join('');
        }

        // Phone number formatting
        function formatPhoneNumber(input) {
            // Сохраняем позицию курсора
            const cursorPosition = input.selectionStart;
            const oldValue = input.value;
            
            // Убираем все нецифровые символы
            let value = input.value.replace(/\D/g, '');
            
            // Если поле пустое, оставляем пустым
            if (value.length === 0) {
                input.value = '';
                return;
            }
            
            // Убираем первую 7 если она есть
            if (value.length >= 1 && value[0] === '7') {
                value = value.substring(1);
            }
            
            // Если после удаления 7 ничего не осталось, оставляем пустым
            if (value.length === 0) {
                input.value = '';
                return;
            }
            
            // Форматируем номер
            let formattedValue = '';
            if (value.length <= 3) {
                formattedValue = `+7 (${value}`;
            } else if (value.length <= 6) {
                formattedValue = `+7 (${value.substring(0, 3)}) ${value.substring(3)}`;
            } else if (value.length <= 8) {
                formattedValue = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
            } else {
                formattedValue = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 8)}-${value.substring(8, 10)}`;
            }
            
            // Устанавливаем новое значение
            input.value = formattedValue;
            
            // Восстанавливаем позицию курсора
            if (oldValue.length > formattedValue.length) {
                // Если значение уменьшилось (удаление), курсор остается на том же месте
                input.setSelectionRange(cursorPosition, cursorPosition);
            } else {
                // Если значение увеличилось (добавление), корректируем позицию
                const newPosition = Math.min(cursorPosition + (formattedValue.length - oldValue.length), formattedValue.length);
                input.setSelectionRange(newPosition, newPosition);
            }
        }

        // Mobile menu functionality
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const mobileMenu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                mobileMenu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            
            if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                mobileMenu.classList.add('hidden');
                const icon = document.querySelector('#mobileMenuBtn i');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
            setupAuthStateChange();
            initializeDateTimeInputs();
            loadAvailableImages();
        });







        // Load Standard Photos and Icons
        async function loadStandardPhotos() {
            try {
                const container = document.getElementById('standardPhotos');
                if (!container) {
                    console.error('Container for standard photos not found');
                    return;
                }
                
                // Используем иконки из папки ICO
                const icoImages = [
                    '../images/ico/icon1.png',
                    '../images/ico/icon2.png',
                    '../images/ico/icon3.png',
                    '../images/ico/icon4.png',
                    '../images/ico/icon5.png',
                    '../images/ico/icon6.png',
                    '../images/ico/icon7.png',
                    '../images/ico/icon8.png',
                    '../images/ico/icon9.png',
                    '../images/ico/icon10.png',
                    '../images/ico/icon11.png',
                    '../images/ico/icon12.png',
                    '../images/ico/icon13.png',
                    '../images/ico/icon14.png',
                    '../images/ico/icon15.png',
                    '../images/ico/icon16.png',
                    '../images/ico/icon17.png',
                    '../images/ico/icon18.png',
                    '../images/ico/icon19.png',
                    '../images/ico/icon20.png',
                    '../images/ico/icon21.png',
                    '../images/ico/icon22.png',
                    '../images/ico/icon23.png',
                    '../images/ico/icon24.png',
                    '../images/ico/icon25.png',
                    '../images/ico/icon26.png',
                    '../images/ico/icon27.png',
                    '../images/ico/icon28.png',
                    '../images/ico/icon29.png',
                    '../images/ico/icon30.png'
                ];
                
                // Расширенный список красивых цветных иконок
                const colorIcons = [
                    { icon: 'fas fa-user', color: 'bg-gradient-to-br from-pink-400 to-pink-600' },
                    { icon: 'fas fa-user-tie', color: 'bg-gradient-to-br from-blue-400 to-blue-600' },
                    { icon: 'fas fa-user-graduate', color: 'bg-gradient-to-br from-green-400 to-green-600' },
                    { icon: 'fas fa-user-ninja', color: 'bg-gradient-to-br from-purple-400 to-purple-600' },
                    { icon: 'fas fa-user-astronaut', color: 'bg-gradient-to-br from-indigo-400 to-indigo-600' },
                    { icon: 'fas fa-user-cowboy', color: 'bg-gradient-to-br from-yellow-400 to-yellow-600' },
                    { icon: 'fas fa-user-doctor', color: 'bg-gradient-to-br from-red-400 to-red-600' },
                    { icon: 'fas fa-user-nurse', color: 'bg-gradient-to-br from-teal-400 to-teal-600' },
                    { icon: 'fas fa-user-secret', color: 'bg-gradient-to-br from-gray-400 to-gray-600' },
                    { icon: 'fas fa-user-tag', color: 'bg-gradient-to-br from-orange-400 to-orange-600' },
                    { icon: 'fas fa-user-check', color: 'bg-gradient-to-br from-emerald-400 to-emerald-600' },
                    { icon: 'fas fa-user-clock', color: 'bg-gradient-to-br from-cyan-400 to-cyan-600' },
                    { icon: 'fas fa-heart', color: 'bg-gradient-to-br from-rose-400 to-rose-600' },
                    { icon: 'fas fa-star', color: 'bg-gradient-to-br from-amber-400 to-amber-600' },
                    { icon: 'fas fa-crown', color: 'bg-gradient-to-br from-yellow-400 to-yellow-600' },
                    { icon: 'fas fa-gem', color: 'bg-gradient-to-br from-violet-400 to-violet-600' },
                    { icon: 'fas fa-sparkles', color: 'bg-gradient-to-br from-sky-400 to-sky-600' },
                    { icon: 'fas fa-fire', color: 'bg-gradient-to-br from-orange-400 to-orange-600' },
                    { icon: 'fas fa-leaf', color: 'bg-gradient-to-br from-green-400 to-green-600' },
                    { icon: 'fas fa-sun', color: 'bg-gradient-to-br from-yellow-400 to-yellow-600' },
                    { icon: 'fas fa-moon', color: 'bg-gradient-to-br from-indigo-400 to-indigo-600' },
                    { icon: 'fas fa-cloud', color: 'bg-gradient-to-br from-blue-400 to-blue-600' },
                    { icon: 'fas fa-flower', color: 'bg-gradient-to-br from-pink-400 to-pink-600' },
                    { icon: 'fas fa-butterfly', color: 'bg-gradient-to-br from-purple-400 to-purple-600' }
                ];
                
                let html = '';
                
                // Добавляем иконки из папки ICO с улучшенным дизайном
                icoImages.forEach((imagePath, index) => {
                    html += `
                        <div class="cursor-pointer group" onclick="selectStandardPhoto('${imagePath}', ${index})">
                            <div class="w-14 h-14 bg-gradient-to-br from-pink-100 to-pink-200 rounded-full flex items-center justify-center overflow-hidden border-2 border-pink-200 hover:border-pink-400 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg">
                                <img src="${imagePath}" alt="Иконка ${index + 1}" class="w-full h-full object-cover" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'; this.parentElement.style.background='linear-gradient(135deg, #f3e8ff 0%, #fdf2f8 100%)';">
                                <i class="fas fa-user text-pink-600 text-xl" style="display: none;"></i>
                            </div>
                        </div>
                    `;
                });
                
                // Добавляем красивые цветные иконки
                colorIcons.forEach((iconData, index) => {
                    html += `
                        <div class="cursor-pointer group" onclick="selectStandardPhoto('icon-${index}', ${icoImages.length + index})">
                            <div class="w-14 h-14 ${iconData.color} rounded-full flex items-center justify-center border-2 border-white hover:border-pink-300 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg">
                                <i class="${iconData.icon} text-white text-xl"></i>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log('Standard photos loaded successfully');
                
            } catch (error) {
                console.error('Error loading standard photos:', error);
                showNotification('error', 'Ошибка загрузки', 'Не удалось загрузить доступные изображения');
            }
        }

        // Select Standard Photo
        function selectStandardPhoto(photoPath, index) {
            try {
                console.log('Selecting photo:', photoPath, index);
                
                // Сохраняем выбранное фото в глобальной переменной
                window.selectedPhotoPath = photoPath;
                
                // Убираем выделение со всех аватарок
                document.querySelectorAll('#standardPhotos > div').forEach(div => {
                    div.querySelector('div').classList.remove('ring-4', 'ring-pink-400', 'ring-offset-2');
                });
                
                // Добавляем выделение к выбранной аватарке
                const selectedDiv = document.querySelectorAll('#standardPhotos > div')[index];
                if (selectedDiv) {
                    selectedDiv.querySelector('div').classList.add('ring-4', 'ring-pink-400', 'ring-offset-2');
                }
                
                // Обновляем фото профиля
                const profileImage = document.getElementById('profileImage');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                const profileImagePreview = document.getElementById('profileImagePreview');
                
                if (!profileImage || !defaultIcon || !profileImagePreview) {
                    throw new Error('Profile image elements not found');
                }
                
                // Проверяем, является ли это иконкой
                if (photoPath.startsWith('icon-')) {
                    // Это иконка - скрываем изображение и показываем иконку
                    profileImage.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                    
                    // Обновляем иконку в основном профиле
                    const mainProfileImage = document.querySelector('#profileSection #profileImagePreview img');
                    const mainDefaultIcon = document.querySelector('#profileSection #profileImagePreview i');
                    
                    if (mainProfileImage) {
                        mainProfileImage.classList.add('hidden');
                    }
                    if (mainDefaultIcon) {
                        mainDefaultIcon.classList.remove('hidden');
                    }
                    
                    // Устанавливаем соответствующую иконку
                    const iconIndex = parseInt(photoPath.split('-')[1]);
                    const iconClasses = [
                        'fas fa-user', 'fas fa-user-tie', 'fas fa-user-graduate', 'fas fa-user-ninja',
                        'fas fa-user-astronaut', 'fas fa-user-cowboy', 'fas fa-user-doctor', 'fas fa-user-nurse',
                        'fas fa-user-secret', 'fas fa-user-tag', 'fas fa-user-check', 'fas fa-user-clock',
                        'fas fa-heart', 'fas fa-star', 'fas fa-crown', 'fas fa-gem', 'fas fa-sparkles',
                        'fas fa-fire', 'fas fa-leaf', 'fas fa-sun', 'fas fa-moon', 'fas fa-cloud',
                        'fas fa-flower', 'fas fa-butterfly'
                    ];
                    const iconColors = [
                        'text-pink-600', 'text-blue-600', 'text-green-600', 'text-purple-600',
                        'text-indigo-600', 'text-yellow-600', 'text-red-600', 'text-teal-600',
                        'text-gray-600', 'text-orange-600', 'text-emerald-600', 'text-cyan-600',
                        'text-rose-600', 'text-amber-600', 'text-yellow-600', 'text-violet-600',
                        'text-sky-600', 'text-orange-600', 'text-green-600', 'text-yellow-600',
                        'text-indigo-600', 'text-blue-600', 'text-pink-600', 'text-purple-600'
                    ];
                    
                    if (iconIndex < iconClasses.length) {
                        defaultIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                        if (mainDefaultIcon) {
                            mainDefaultIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                        }
                    }
                    
                    // Сохраняем выбор в localStorage
                    localStorage.setItem('selectedAvatar', photoPath);
                    
                } else {
                    // Это изображение
                    profileImage.src = photoPath;
                    profileImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    
                    // Обновляем основное фото профиля
                    const mainProfileImage = document.querySelector('#profileSection #profileImagePreview img');
                    if (mainProfileImage) {
                        mainProfileImage.src = photoPath;
                        mainProfileImage.classList.remove('hidden');
                    } else {
                        // Создаем изображение если его нет
                        const newImg = document.createElement('img');
                        newImg.src = photoPath;
                        newImg.alt = 'Фото профиля';
                        newImg.className = 'w-full h-full object-cover';
                        const container = document.querySelector('#profileSection #profileImagePreview');
                        if (container) {
                            container.appendChild(newImg);
                        }
                    }
                    
                    // Скрываем иконку по умолчанию в основном профиле
                    const mainDefaultIcon = document.querySelector('#profileSection #profileImagePreview i');
                    if (mainDefaultIcon) {
                        mainDefaultIcon.classList.add('hidden');
                    }
                    
                    // Сохраняем выбор в localStorage
                    localStorage.setItem('selectedAvatar', photoPath);
                }
                
                // Показываем уведомление об успешном выборе
                showNotification('success', 'Фото выбрано!', 'Нажмите "Сохранить" для применения изменений');
                
            } catch (error) {
                console.error('Error selecting standard photo:', error);
                showNotification('error', 'Ошибка', 'Не удалось выбрать изображение');
            }
        }

        // Apply Selected Photo
        function applySelectedPhoto(photoPath) {
            try {
                console.log('Applying selected photo:', photoPath);
                
                // Проверяем, является ли это иконкой
                if (photoPath.startsWith('icon-')) {
                    // Это иконка - применяем её
                    const iconIndex = parseInt(photoPath.split('-')[1]);
                    const iconClasses = [
                        'fas fa-user', 'fas fa-user-tie', 'fas fa-user-graduate', 'fas fa-user-ninja',
                        'fas fa-user-astronaut', 'fas fa-user-cowboy', 'fas fa-user-doctor', 'fas fa-user-nurse',
                        'fas fa-user-secret', 'fas fa-user-tag', 'fas fa-user-check', 'fas fa-user-clock',
                        'fas fa-heart', 'fas fa-star', 'fas fa-crown', 'fas fa-gem', 'fas fa-sparkles',
                        'fas fa-fire', 'fas fa-leaf', 'fas fa-sun', 'fas fa-moon', 'fas fa-cloud',
                        'fas fa-flower', 'fas fa-butterfly'
                    ];
                    const iconColors = [
                        'text-pink-600', 'text-blue-600', 'text-green-600', 'text-purple-600',
                        'text-indigo-600', 'text-yellow-600', 'text-red-600', 'text-teal-600',
                        'text-gray-600', 'text-orange-600', 'text-emerald-600', 'text-cyan-600',
                        'text-rose-600', 'text-amber-600', 'text-yellow-600', 'text-violet-600',
                        'text-sky-600', 'text-orange-600', 'text-green-600', 'text-yellow-600',
                        'text-indigo-600', 'text-blue-600', 'text-pink-600', 'text-purple-600'
                    ];
                    
                    if (iconIndex < iconClasses.length) {
                        // Обновляем иконку в модальном окне
                        const defaultIcon = document.getElementById('defaultProfileIcon');
                        const profileImage = document.getElementById('profileImage');
                        
                        if (defaultIcon) {
                            defaultIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                            defaultIcon.classList.remove('hidden');
                        }
                        if (profileImage) {
                            profileImage.classList.add('hidden');
                        }
                        
                        // Обновляем иконку в основном профиле
                        const mainProfileIcon = document.getElementById('mainProfileIcon');
                        const mainProfileImage = document.getElementById('mainProfileImage');
                        
                        if (mainProfileIcon) {
                            mainProfileIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                            mainProfileIcon.classList.remove('hidden');
                        }
                        if (mainProfileImage) {
                            mainProfileImage.classList.add('hidden');
                        }
                    }
                    
                } else {
                    // Это изображение - применяем его
                    const profileImage = document.getElementById('profileImage');
                    const defaultIcon = document.getElementById('defaultProfileIcon');
                    
                    if (profileImage) {
                        profileImage.src = photoPath;
                        profileImage.classList.remove('hidden');
                    }
                    if (defaultIcon) {
                        defaultIcon.classList.add('hidden');
                    }
                    
                    // Обновляем основное фото профиля
                    const mainProfileImage = document.getElementById('mainProfileImage');
                    const mainProfileIcon = document.getElementById('mainProfileIcon');
                    
                    if (mainProfileImage) {
                        mainProfileImage.src = photoPath;
                        mainProfileImage.classList.remove('hidden');
                    }
                    if (mainProfileIcon) {
                        mainProfileIcon.classList.add('hidden');
                    }
                }
                
                // Сохраняем в localStorage
                localStorage.setItem('selectedAvatar', photoPath);
                
                // Обновляем аватарку на главной странице через событие
                window.dispatchEvent(new CustomEvent('avatarUpdated', { detail: photoPath }));
                
                // Показываем уведомление об успехе
                showNotification('success', 'Фото применено!', 'Ваше фото профиля успешно обновлено');
                
            } catch (error) {
                console.error('Error applying selected photo:', error);
                showNotification('error', 'Ошибка', 'Не удалось применить выбранное фото');
            }
        }

        // Handle custom photo upload
        function handleCustomPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Проверяем размер файла (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('error', 'Ошибка', 'Файл слишком большой. Максимальный размер: 5MB');
                event.target.value = '';
                return;
            }
            
            // Проверяем тип файла
            if (!file.type.startsWith('image/')) {
                showNotification('error', 'Ошибка', 'Пожалуйста, выберите изображение');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Обновляем фото профиля
                const profileImage = document.getElementById('profileImage');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                
                if (profileImage && defaultIcon) {
                    profileImage.src = imageData;
                    profileImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    
                    // Обновляем основное фото профиля
                    const mainProfileImage = document.getElementById('mainProfileImage');
                    const mainProfileIcon = document.getElementById('mainProfileIcon');
                    
                    if (mainProfileImage) {
                        mainProfileImage.src = imageData;
                        mainProfileImage.classList.remove('hidden');
                    }
                    if (mainProfileIcon) {
                        mainProfileIcon.classList.add('hidden');
                    }
                    
                    // Сохраняем в localStorage
                    localStorage.setItem('selectedAvatar', imageData);
                    
                    // Обновляем аватарку на главной странице через событие
                    window.dispatchEvent(new CustomEvent('avatarUpdated', { detail: imageData }));
                    
                    showNotification('success', 'Фото загружено!', 'Ваше фото успешно загружено');
                }
            };
            
            reader.onerror = function() {
                showNotification('error', 'Ошибка', 'Не удалось загрузить изображение');
            };
            
            reader.readAsDataURL(file);
        }

        // Setup auth state change listener
        function setupAuthStateChange() {
            const client = window.supabaseClient || supabaseClient;
            if (client) {
                console.log('Настраиваем отслеживание состояния аутентификации...');
                client.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event, session);
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        
                        // Сохраняем пользователя в localStorage
                        localStorage.setItem('currentUser', JSON.stringify(session.user));
                        
                        // Отправляем событие о входе пользователя
                        window.dispatchEvent(new CustomEvent('userLoggedIn', { detail: session.user }));
                        
                        showProfile();
                        // Сразу показываем данные из currentUser
                        showUserDataImmediately(session.user);
                        // Затем загружаем полный профиль из базы данных
                        loadUserProfile();
                        // loadBookings(); // Временно отключено
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        
                        // Очищаем данные пользователя
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('selectedAvatar');
                        
                        // Отправляем событие о выходе пользователя
                        window.dispatchEvent(new CustomEvent('userLoggedOut'));
                        
                        showAuth();
                    }
                });
            } else {
                console.error('Supabase клиент не найден для настройки auth state change');
            }
        }

        // Load saved avatar on page load
        function loadSavedAvatarOnPageLoad() {
            try {
                const savedAvatar = localStorage.getItem('selectedAvatar');
                if (savedAvatar) {
                    console.log('Loading saved avatar:', savedAvatar);
                    
                    // Элементы в модальном окне редактирования
                    const profileImage = document.getElementById('profileImage');
                    const defaultIcon = document.getElementById('defaultProfileIcon');
                    
                    // Элементы в основном профиле
                    const mainProfileImage = document.getElementById('mainProfileImage');
                    const mainProfileIcon = document.getElementById('mainProfileIcon');
                    
                    if (savedAvatar.startsWith('icon-')) {
                        // Это иконка
                        const iconIndex = parseInt(savedAvatar.split('-')[1]);
                        const iconClasses = [
                            'fas fa-user', 'fas fa-user-tie', 'fas fa-user-graduate', 'fas fa-user-ninja',
                            'fas fa-user-astronaut', 'fas fa-user-cowboy', 'fas fa-user-doctor', 'fas fa-user-nurse',
                            'fas fa-user-secret', 'fas fa-user-tag', 'fas fa-user-check', 'fas fa-user-clock',
                            'fas fa-heart', 'fas fa-star', 'fas fa-crown', 'fas fa-gem', 'fas fa-sparkles',
                            'fas fa-fire', 'fas fa-leaf', 'fas fa-sun', 'fas fa-moon', 'fas fa-cloud',
                            'fas fa-flower', 'fas fa-butterfly'
                        ];
                        const iconColors = [
                            'text-pink-600', 'text-blue-600', 'text-green-600', 'text-purple-600',
                            'text-indigo-600', 'text-yellow-600', 'text-red-600', 'text-teal-600',
                            'text-gray-600', 'text-orange-600', 'text-emerald-600', 'text-cyan-600',
                            'text-rose-600', 'text-amber-600', 'text-yellow-600', 'text-violet-600',
                            'text-sky-600', 'text-orange-600', 'text-green-600', 'text-yellow-600',
                            'text-indigo-600', 'text-blue-600', 'text-pink-600', 'text-purple-600'
                        ];
                        
                        if (iconIndex < iconClasses.length) {
                            // Обновляем иконку в модальном окне
                            if (defaultIcon) {
                                defaultIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                                defaultIcon.classList.remove('hidden');
                            }
                            if (profileImage) {
                                profileImage.classList.add('hidden');
                            }
                            
                            // Обновляем иконку в основном профиле
                            if (mainProfileIcon) {
                                mainProfileIcon.className = `${iconClasses[iconIndex]} text-3xl ${iconColors[iconIndex]}`;
                                mainProfileIcon.classList.remove('hidden');
                            }
                            if (mainProfileImage) {
                                mainProfileImage.classList.add('hidden');
                            }
                        }
                    } else {
                        // Это изображение
                        // Обновляем изображение в модальном окне
                        if (profileImage) {
                            profileImage.src = savedAvatar;
                            profileImage.classList.remove('hidden');
                        }
                        if (defaultIcon) {
                            defaultIcon.classList.add('hidden');
                        }
                        
                        // Обновляем изображение в основном профиле
                        if (mainProfileImage) {
                            mainProfileImage.src = savedAvatar;
                            mainProfileImage.classList.remove('hidden');
                        }
                        if (mainProfileIcon) {
                            mainProfileIcon.classList.add('hidden');
                        }
                    }
                    
                    console.log('Avatar loaded successfully');
                }
            } catch (error) {
                console.error('Error loading saved avatar on page load:', error);
            }
        }

        // Initialize service card handlers when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved avatar
            loadSavedAvatarOnPageLoad();
            
            // Phone number formatting
            const phoneInput = document.getElementById('bookingPhone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    formatPhoneNumber(this);
                });
                
                // Обработчик для клавиш
                phoneInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace') {
                        // Если курсор в начале или после +7, не даем стереть
                        const cursorPosition = this.selectionStart;
                        if (cursorPosition <= 4) { // +7 (
                            e.preventDefault();
                            return;
                        }
                    }
                    
                    // Разрешаем Ctrl+A для выделения всего текста
                    if (e.ctrlKey && e.key === 'a') {
                        return; // Разрешаем стандартное поведение
                    }
                    
                    // Разрешаем Delete для удаления выделенного текста
                    if (e.key === 'Delete') {
                        return; // Разрешаем стандартное поведение
                    }
                });
            }
            
            // Service Card Click Handlers
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', () => {
                    // Убираем выделение со всех карточек
                    document.querySelectorAll('.service-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Добавляем выделение к выбранной карточке
                    card.classList.add('selected');
                    
                    const service = card.getAttribute('data-service');
                    const price = card.getAttribute('data-price');
                    const serviceName = card.querySelector('h4').textContent;
                    
                    // Заполняем скрытые поля
                    document.getElementById('selectedService').value = service;
                    document.getElementById('selectedServicePrice').value = price;
                    document.getElementById('selectedServiceName').textContent = serviceName;
                    
                    // Показываем уведомление о выборе
                    showNotification('success', 'Услуга выбрана!', `Выбрана услуга: ${serviceName}`);
                    
                    // Небольшая задержка перед показом формы для лучшего UX
                    setTimeout(() => {
                        // Скрываем все сетки услуг, показываем форму
                        document.getElementById('hairServicesGrid').classList.add('hidden');
                        document.getElementById('manicureServicesGrid').classList.add('hidden');
                        document.getElementById('bookingFormContainer').classList.remove('hidden');
                        
                        // Предзаполняем телефон, если есть в профиле
                        const phoneInput = document.getElementById('bookingPhone');
                        if (phoneInput && currentUser) {
                            const userPhone = currentUser.phone || currentUser.user_metadata?.phone;
                            if (userPhone && userPhone !== 'Не указан') {
                                phoneInput.value = userPhone;
                            }
                        }
                    }, 500);
                });
            });
        });

        // iOS Style Menu Handlers for account page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up menu handlers');
            console.log('Setting up all event handlers...');
            
            let isMenuOpen = false;
            const iosMenuBtn = document.getElementById('iosMenuBtn');
            const sideMenu = document.getElementById('sideMenu');
            const closeMenuBtn = document.getElementById('closeMenuBtn');
            const menuBackdrop = document.getElementById('menuBackdrop');
            const menuContainer = document.getElementById('menuContainer');
            
            // Debug: Check if elements exist
            console.log('Menu elements found:', {
                iosMenuBtn: !!iosMenuBtn,
                sideMenu: !!sideMenu,
                closeMenuBtn: !!closeMenuBtn,
                menuBackdrop: !!menuBackdrop,
                menuContainer: !!menuContainer
            });

            // Haptic feedback function
            function triggerHapticFeedback() {
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
                // Fallback visual feedback
                document.body.classList.add('haptic-feedback');
                setTimeout(() => {
                    document.body.classList.remove('haptic-feedback');
                }, 100);
            }

            // Open menu function
            function openMenu() {
                console.log('Opening menu, isMenuOpen:', isMenuOpen);
                if (isMenuOpen) return;
                
                if (!sideMenu) {
                    console.error('Side menu element not found!');
                    return;
                }
                
                triggerHapticFeedback();
                isMenuOpen = true;
                sideMenu.classList.add('open');
                document.body.classList.add('menu-open');
                iosMenuBtn.classList.add('active');
                
                // Prevent any background interactions
                setTimeout(() => {
                    sideMenu.style.pointerEvents = 'all';
                }, 50);
                
                console.log('Menu opened successfully');
                console.log('Side menu classes:', sideMenu.className);
                console.log('Side menu style:', sideMenu.style.cssText);
            }

            // Close menu function
            function closeMenu() {
                console.log('Closing menu, isMenuOpen:', isMenuOpen);
                if (!isMenuOpen) return;
                
                triggerHapticFeedback();
                isMenuOpen = false;
                sideMenu.classList.remove('open');
                document.body.classList.remove('menu-open');
                iosMenuBtn.classList.remove('active');
                sideMenu.style.pointerEvents = 'none';
                
                console.log('Menu closed successfully');
            }

            // Event listeners
            if (iosMenuBtn) {
                console.log('Adding click listener to menu button');
                iosMenuBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Menu button clicked, isMenuOpen:', isMenuOpen);
                    
                    if (isMenuOpen) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });
            } else {
                console.error('Menu button not found!');
            }

            if (closeMenuBtn) {
                closeMenuBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Close button clicked');
                    triggerHapticFeedback();
                    closeMenu();
                });
            }

            if (menuBackdrop) {
                menuBackdrop.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeMenu();
                });
            }

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (isMenuOpen && !sideMenu.contains(e.target) && !iosMenuBtn.contains(e.target)) {
                    closeMenu();
                }
            });

            // Close menu on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isMenuOpen) {
                    closeMenu();
                }
            });

            // Menu item click handlers
            function setupMenuHandlers() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        triggerHapticFeedback();
                        
                        // Add bubble animation
                        item.classList.add('bubble-animation');
                        setTimeout(() => {
                            item.classList.remove('bubble-animation');
                        }, 400);
                        
                        // Get the href and navigate
                        const href = item.getAttribute('href');
                        if (href) {
                            // Close menu immediately
                            closeMenu();
                            
                            // Navigate after a short delay for haptic feedback
                            setTimeout(() => {
                                if (href.startsWith('#')) {
                                    // Smooth scroll to section
                                    const target = document.querySelector(href);
                                    if (target) {
                                        target.scrollIntoView({ behavior: 'smooth' });
                                    }
                                } else {
                                    // Navigate to page
                                    window.location.href = href;
                                }
                            }, 200);
                        }
                    });
                });
            }

            // Setup menu handlers after menu is created
            setupMenuHandlers();
            
            // Booking Modal Controls
            const newBookingBtn = document.getElementById('newBookingBtn');
            console.log('newBookingBtn found:', !!newBookingBtn);
            if (newBookingBtn) {
                newBookingBtn.addEventListener('click', () => {
                    console.log('newBookingBtn clicked!');
                    const bookingModal = document.getElementById('bookingModal');
                    const categorySelection = document.getElementById('categorySelection');
                    const hairServicesGrid = document.getElementById('hairServicesGrid');
                    const manicureServicesGrid = document.getElementById('manicureServicesGrid');
                    const bookingFormContainer = document.getElementById('bookingFormContainer');
                    
                    console.log('Modal elements:', {
                        bookingModal: !!bookingModal,
                        categorySelection: !!categorySelection,
                        hairServicesGrid: !!hairServicesGrid,
                        manicureServicesGrid: !!manicureServicesGrid,
                        bookingFormContainer: !!bookingFormContainer
                    });
                    
                    bookingModal.classList.remove('hidden');
                    // Показываем категории, скрываем все остальное
                    categorySelection.classList.remove('hidden');
                    hairServicesGrid.classList.add('hidden');
                    manicureServicesGrid.classList.add('hidden');
                    bookingFormContainer.classList.add('hidden');
                });
            }

            const bookFirstBtn = document.getElementById('bookFirstBtn');
            console.log('bookFirstBtn found:', !!bookFirstBtn);
            if (bookFirstBtn) {
                bookFirstBtn.addEventListener('click', () => {
                    console.log('bookFirstBtn clicked!');
                    document.getElementById('bookingModal').classList.remove('hidden');
                    // Показываем категории, скрываем все остальное
                    document.getElementById('categorySelection').classList.remove('hidden');
                    document.getElementById('hairServicesGrid').classList.add('hidden');
                    document.getElementById('manicureServicesGrid').classList.add('hidden');
                    document.getElementById('bookingFormContainer').classList.add('hidden');
                });
            }

            const closeModalBtn = document.getElementById('closeModalBtn');
            console.log('closeModalBtn found:', !!closeModalBtn);
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    console.log('closeModalBtn clicked!');
                    // Убираем выделение со всех карточек
                    document.querySelectorAll('.service-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Сбрасываем к категориям
                    document.getElementById('categorySelection').classList.remove('hidden');
                    document.getElementById('hairServicesGrid').classList.add('hidden');
                    document.getElementById('manicureServicesGrid').classList.add('hidden');
                    document.getElementById('bookingFormContainer').classList.add('hidden');
                    
                    document.getElementById('bookingModal').classList.add('hidden');
                });
            }

            // Category Selection
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.getAttribute('data-category');
                    
                    if (category === 'hair') {
                        document.getElementById('categorySelection').classList.add('hidden');
                        document.getElementById('hairServicesGrid').classList.remove('hidden');
                    } else if (category === 'manicure') {
                        document.getElementById('categorySelection').classList.add('hidden');
                        document.getElementById('manicureServicesGrid').classList.remove('hidden');
                    }
                });
            });

            // Back to Categories Buttons
            const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
            if (backToCategoriesBtn) {
                backToCategoriesBtn.addEventListener('click', () => {
                    document.getElementById('categorySelection').classList.remove('hidden');
                    document.getElementById('hairServicesGrid').classList.add('hidden');
                    document.getElementById('manicureServicesGrid').classList.add('hidden');
                    document.getElementById('bookingFormContainer').classList.add('hidden');
                });
            }

            const backToCategoriesBtn2 = document.getElementById('backToCategoriesBtn2');
            if (backToCategoriesBtn2) {
                backToCategoriesBtn2.addEventListener('click', () => {
                    document.getElementById('categorySelection').classList.remove('hidden');
                    document.getElementById('hairServicesGrid').classList.add('hidden');
                    document.getElementById('manicureServicesGrid').classList.add('hidden');
                    document.getElementById('bookingFormContainer').classList.add('hidden');
                });
            }

            // Back to Services Button
            const backToServicesBtn = document.getElementById('backToServicesBtn');
            if (backToServicesBtn) {
                backToServicesBtn.addEventListener('click', () => {
                    // Убираем выделение со всех карточек
                    document.querySelectorAll('.service-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Показываем текущую сетку услуг
                    const hairGrid = document.getElementById('hairServicesGrid');
                    const manicureGrid = document.getElementById('manicureServicesGrid');
                    
                    if (!hairGrid.classList.contains('hidden')) {
                        document.getElementById('hairServicesGrid').classList.remove('hidden');
                    } else if (!manicureGrid.classList.contains('hidden')) {
                        document.getElementById('manicureServicesGrid').classList.remove('hidden');
                    }
                    
                    document.getElementById('bookingFormContainer').classList.add('hidden');
                });
            }
            
            // Edit Profile Modal
            const editProfileBtn = document.getElementById('editProfileBtn');
            console.log('editProfileBtn found:', !!editProfileBtn);
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => {
                    console.log('editProfileBtn clicked!');
                    const modal = document.getElementById('editProfileModal');
                    const fullNameInput = document.getElementById('editFullName');
                    const phoneInput = document.getElementById('editPhone');
                    
                    console.log('Modal elements:', {
                        modal: !!modal,
                        fullNameInput: !!fullNameInput,
                        phoneInput: !!phoneInput
                    });
                    
                    // Fill current values
                    fullNameInput.value = document.getElementById('userName').textContent;
                    phoneInput.value = document.getElementById('userPhone').textContent === 'Не указан' ? '' : document.getElementById('userPhone').textContent;
                    
                    modal.classList.remove('hidden');
                });
            }

            // Close Edit Profile Modal
            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            console.log('closeEditModalBtn found:', !!closeEditModalBtn);
            if (closeEditModalBtn) {
                closeEditModalBtn.addEventListener('click', () => {
                    console.log('closeEditModalBtn clicked!');
                    document.getElementById('editProfileModal').classList.add('hidden');
                });
            }

            // Cancel Edit Profile
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            console.log('cancelEditBtn found:', !!cancelEditBtn);
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    console.log('cancelEditBtn clicked!');
                    document.getElementById('editProfileModal').classList.add('hidden');
                });
            }

            // Change Photo Button
            const changePhotoBtn = document.getElementById('changePhotoBtn');
            if (changePhotoBtn) {
                changePhotoBtn.addEventListener('click', () => {
                    document.getElementById('photoSelectionModal').classList.remove('hidden');
                    loadStandardPhotos(); // Загружаем стандартные фото при открытии модального окна
                });
            }

            // Close Photo Selection Modal
            const closePhotoModalBtn = document.getElementById('closePhotoModalBtn');
            if (closePhotoModalBtn) {
                closePhotoModalBtn.addEventListener('click', () => {
                    document.getElementById('photoSelectionModal').classList.add('hidden');
                });
            }

            // Cancel Photo Selection
            const cancelPhotoBtn = document.getElementById('cancelPhotoBtn');
            if (cancelPhotoBtn) {
                cancelPhotoBtn.addEventListener('click', () => {
                    document.getElementById('photoSelectionModal').classList.add('hidden');
                });
            }

            // Save Photo Selection
            const savePhotoBtn = document.getElementById('savePhotoBtn');
            if (savePhotoBtn) {
                savePhotoBtn.addEventListener('click', () => {
                    // Если выбрано фото, применяем его
                    if (window.selectedPhotoPath) {
                        applySelectedPhoto(window.selectedPhotoPath);
                    }
                    document.getElementById('photoSelectionModal').classList.add('hidden');
                });
            }

            // Handle Edit Profile Form
            const editProfileForm = document.getElementById('editProfileForm');
            console.log('editProfileForm found:', !!editProfileForm);
            if (editProfileForm) {
                editProfileForm.addEventListener('submit', async (e) => {
                    console.log('editProfileForm submitted!');
                    e.preventDefault();
                    
                    const fullName = document.getElementById('editFullName').value;
                    const phone = document.getElementById('editPhone').value;
                    
                    // Сразу обновляем UI для быстрого отклика
                    document.getElementById('userName').textContent = fullName;
                    document.getElementById('userPhone').textContent = phone || 'Не указан';
                    
                    // Закрываем модальное окно
                    document.getElementById('editProfileModal').classList.add('hidden');
                    
                    // Показываем уведомление об успехе
                    showNotification('success', 'Профиль обновлен!', 'Ваши данные успешно сохранены');
                    
                    // Асинхронно сохраняем в базу данных
                    setTimeout(async () => {
                        try {
                            const client = window.supabaseClient || supabaseClient;
                            if (client) {
                                const { error } = await client
                                    .from('profiles')
                                    .update({
                                        full_name: fullName,
                                        phone: phone || null,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', currentUser.id);
                                
                                if (error) {
                                    console.error('Error saving to database:', error);
                                    showNotification('warning', 'Внимание', 'Данные сохранены локально, но есть проблемы с сервером');
                                }
                            }
                        } catch (error) {
                            console.error('Error saving to database:', error);
                            showNotification('warning', 'Внимание', 'Данные сохранены локально, но есть проблемы с сервером');
                        }
                    }, 100);
                });
            }

            // Административные функции
            const ADMIN_EMAILS = ['my@vadimktv.ru', 'my@annaktv.ru', 'my@svetsalonpro.ru'];
            let isAdmin = false;
            let currentUserEmail = null;

            // Проверка административных привилегий
            function checkAdminPrivileges(email) {
                if (!email) return false;
                return ADMIN_EMAILS.includes(email.toLowerCase());
            }

            // Показать/скрыть кнопки администратора
            function toggleAdminButtons(show) {
                const adminBtn = document.getElementById('adminPanelBtn');
                const mobileAdminBtn = document.getElementById('mobileAdminPanelBtn');
                
                if (adminBtn) {
                    adminBtn.style.display = show ? 'block' : 'none';
                }
                if (mobileAdminBtn) {
                    mobileAdminBtn.style.display = show ? 'block' : 'none';
                }
                
                console.log('Admin buttons toggled:', show);
            }

            // Открыть административное модальное окно
            function openAdminModal() {
                const modal = document.getElementById('adminModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    document.getElementById('adminLogin').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('hidden');
                    document.getElementById('adminPassword').value = '';
                }
            }

            // Закрыть административное модальное окно
            function closeAdminModal() {
                const modal = document.getElementById('adminModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            // Проверить пароль администратора
            function checkAdminPassword() {
                const password = document.getElementById('adminPassword').value;
                const correctPassword = 'SvetSalonPro2024!'; // Пароль администратора
                
                if (password === correctPassword) {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    showNotification('success', 'Добро пожаловать в админ панель!', 'Успешная авторизация');
                } else {
                    showNotification('error', 'Ошибка!', 'Неверный пароль');
                }
            }

            // Показать забронированное время
            function showBookedTimes() {
                const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                if (bookings.length === 0) {
                    showNotification('info', 'Информация', 'Записей пока нет');
                    return;
                }
                
                let message = '📅 Забронированное время:\n\n';
                bookings.forEach((booking, index) => {
                    message += `${index + 1}. ${booking.name} - ${booking.date} в ${booking.time}\n`;
                    message += `   Услуга: ${booking.service}\n`;
                    message += `   Телефон: ${booking.phone}\n\n`;
                });
                
                alert(message);
            }

            // Очистить все записи
            function clearAllBookings() {
                if (confirm('Вы уверены, что хотите удалить ВСЕ записи? Это действие нельзя отменить!')) {
                    localStorage.removeItem('bookings');
                    showNotification('success', 'Успех!', 'Все записи удалены');
                }
            }

            // Экспорт записей
            function exportBookings() {
                const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                if (bookings.length === 0) {
                    showNotification('info', 'Информация', 'Записей для экспорта нет');
                    return;
                }
                
                const csvContent = 'data:text/csv;charset=utf-8,' + 
                    'Имя,Телефон,Дата,Время,Услуга,Категория\n' +
                    bookings.map(booking => 
                        `"${booking.name}","${booking.phone}","${booking.date}","${booking.time}","${booking.service}","${booking.category}"`
                    ).join('\n');
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `bookings_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('success', 'Экспорт завершен!', 'Файл скачан');
            }

            // Обработчики для кнопок администратора
            const adminBtn = document.getElementById('adminPanelBtn');
            const mobileAdminBtn = document.getElementById('mobileAdminPanelBtn');
            
            console.log('Admin buttons found:', {
                adminBtn: !!adminBtn,
                mobileAdminBtn: !!mobileAdminBtn
            });
            
            if (adminBtn) {
                adminBtn.addEventListener('click', openAdminModal);
            }
            if (mobileAdminBtn) {
                mobileAdminBtn.addEventListener('click', openAdminModal);
            }

            // Проверяем, есть ли сохраненный пользователь
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    currentUserEmail = user.email;
                    if (checkAdminPrivileges(currentUserEmail)) {
                        isAdmin = true;
                        toggleAdminButtons(true);
                        showNotification('success', 'Добро пожаловать, администратор!', 'У вас есть административные привилегии');
                    }
                } catch (e) {
                    console.error('Ошибка при парсинге пользователя:', e);
                }
            }

            // Слушаем события авторизации
            window.addEventListener('userLoggedIn', function(event) {
                const user = event.detail;
                currentUserEmail = user.email;
                console.log('User logged in:', currentUserEmail);
                
                if (checkAdminPrivileges(currentUserEmail)) {
                    isAdmin = true;
                    toggleAdminButtons(true);
                    showNotification('success', 'Добро пожаловать, администратор!', 'У вас есть административные привилегии');
                    console.log('Admin privileges granted');
                } else {
                    isAdmin = false;
                    toggleAdminButtons(false);
                    console.log('Regular user, no admin privileges');
                }
            });

            window.addEventListener('userLoggedOut', function() {
                isAdmin = false;
                currentUserEmail = null;
                toggleAdminButtons(false);
                
                // Сбрасываем профиль в личном кабинете
                const mainProfileIcon = document.getElementById('mainProfileIcon');
                const mainProfileImage = document.getElementById('mainProfileImage');
                
                if (mainProfileIcon) {
                    mainProfileIcon.style.display = 'block';
                    mainProfileIcon.className = 'fas fa-user text-3xl text-pink-600';
                }
                
                if (mainProfileImage) {
                    mainProfileImage.style.display = 'none';
                }
                
                console.log('Profile reset in account page after logout');
            });
        });

    </script>

    <!-- Административное модальное окно -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">🔐 Админ панель</h2>
                <button onclick="closeAdminModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div id="adminLogin" class="space-y-4">
                <p class="text-gray-600">Введите пароль администратора:</p>
                <input type="password" id="adminPassword" placeholder="Пароль" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                <button onclick="checkAdminPassword()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg transition">Войти</button>
            </div>
            
            <div id="adminPanel" class="space-y-4 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Панель управления</h3>
                <button onclick="showBookedTimes()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition">📅 Просмотреть забронированное время</button>
                <button onclick="clearAllBookings()" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition">🗑️ Очистить все записи</button>
                <button onclick="exportBookings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition">📤 Экспорт записей</button>
                <button onclick="closeAdminModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition">Закрыть</button>
            </div>
        </div>
    </div>
</body>
</html>
