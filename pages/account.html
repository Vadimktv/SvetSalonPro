<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Личный кабинет - SvetSalonPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../images/logo.png">
    <link rel="shortcut icon" type="image/png" href="../images/logo.png">
    <script>
        // Глобальная переменная для Supabase
        let supabaseClient = null;
        
        // Функция загрузки Supabase SDK
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                // Пробуем загрузить с unpkg
                const script1 = document.createElement('script');
                script1.src = 'https://unpkg.com/@supabase/supabase-js@2';
                script1.onload = () => {
                    console.log('Supabase SDK загружен с unpkg');
                    // Ждем немного, чтобы SDK полностью инициализировался
                    setTimeout(() => {
                        if (typeof window.supabase !== 'undefined') {
                            console.log('Supabase SDK готов к использованию в window.supabase');
                            resolve();
                        } else if (typeof supabase !== 'undefined') {
                            console.log('Supabase SDK готов к использованию в глобальной переменной');
                            // Делаем доступным в window
                            window.supabase = supabase;
                            resolve();
                        } else {
                            reject(new Error('Supabase SDK загружен, но не инициализирован'));
                        }
                    }, 200);
                };
                script1.onerror = () => {
                    console.log('Ошибка загрузки с unpkg, пробуем cdn.jsdelivr.net');
                    
                    // Пробуем альтернативный источник
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script2.onload = () => {
                        console.log('Supabase SDK загружен с cdn.jsdelivr.net');
                        setTimeout(() => {
                            if (typeof window.supabase !== 'undefined') {
                                console.log('Supabase SDK готов к использованию в window.supabase');
                                resolve();
                            } else if (typeof supabase !== 'undefined') {
                                console.log('Supabase SDK готов к использованию в глобальной переменной');
                                window.supabase = supabase;
                                resolve();
                            } else {
                                reject(new Error('Supabase SDK загружен, но не инициализирован'));
                            }
                        }, 200);
                    };
                    script2.onerror = () => {
                        reject(new Error('Не удалось загрузить Supabase SDK'));
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }
        
        // Загружаем SDK при загрузке страницы
        window.addEventListener('load', async function() {
            try {
                await loadSupabase();
                console.log('Supabase SDK загружен успешно!');
                // Запускаем инициализацию
                if (typeof initSupabase === 'function') {
                    initSupabase();
                }
            } catch (error) {
                console.error('Ошибка загрузки Supabase:', error);
                alert('Ошибка: ' + error.message);
            }
        });
    </script>
    <script src="../supabase-config.js"></script>
    <style>
        .logo-image {
            height: 40px;
            width: 40px;
            object-fit: cover;
            border-radius: 9999px;
            transition: transform 0.3s ease;
        }
        .logo-image:hover {
            transform: scale(1.05);
        }
        
        .nav-link:hover::after {
            content: '';
            display: block;
            width: 100%;
            height: 2px;
            background-color: #ec4899;
            margin-top: 2px;
        }

        .form-input:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        /* Улучшенные стили для полей ввода */
        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: #ffffff;
        }
        
        .form-input:hover {
            border-color: #9ca3af;
        }
        
        /* Специальные стили для полей даты и времени */
        input[type="date"], input[type="time"], select {
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }
        
        input[type="date"]:focus, input[type="time"]:focus, select:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px 0 rgba(236,72,153,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(236, 72, 153, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px 0 rgba(236,72,153,0.15);
        }

        .auth-form {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(251, 207, 232, 0.1) 100%);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans bg-gradient-to-br from-pink-50 to-white text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="fixed w-full bg-white shadow-sm z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="../index.html" class="logo-link"><img src="../images/logo.png" alt="SvetSalonPro" class="logo-image mr-3"></a>
                <h1 class="text-2xl font-bold text-pink-600">SvetSalonPro</h1>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="../index.html#home" class="nav-link text-gray-700 hover:text-pink-600 transition">Главная</a>
                <a href="../index.html#about" class="nav-link text-gray-700 hover:text-pink-600 transition">О нас</a>
                <a href="../index.html#services" class="nav-link text-gray-700 hover:text-pink-600 transition">Услуги</a>
                <a href="../index.html#masters" class="nav-link text-gray-700 hover:text-pink-600 transition">Мастера</a>
                <a href="../index.html#contact" class="nav-link text-gray-700 hover:text-pink-600 transition">Контакты</a>
                <a href="account.html" class="nav-link text-pink-600 font-semibold">Личный кабинет</a>
            </nav>
            <button id="mobileMenuBtn" class="md:hidden text-gray-700">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-gray-200">
            <div class="px-4 py-6 space-y-4">
                <a href="../index.html#home" class="block text-gray-700 hover:text-pink-600 transition py-2">Главная</a>
                <a href="../index.html#about" class="block text-gray-700 hover:text-pink-600 transition py-2">О нас</a>
                <a href="../index.html#services" class="block text-gray-700 hover:text-pink-600 transition py-2">Услуги</a>
                <a href="../index.html#masters" class="block text-gray-700 hover:text-pink-600 transition py-2">Мастера</a>
                <a href="../index.html#contact" class="block text-gray-700 hover:text-pink-600 transition py-2">Контакты</a>
                <a href="account.html" class="block text-pink-600 font-semibold py-2">Личный кабинет</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-32 pb-20">
        <div class="container mx-auto px-4">
            <!-- Auth Section -->
            <div id="authSection" class="max-w-md mx-auto mb-8 fade-in">
                <div class="card rounded-xl p-8 text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Вход в личный кабинет</h2>
                    
                    <!-- Login Form -->
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label for="email" class="block text-gray-700 font-medium mb-2 text-left">Email</label>
                            <input type="email" id="email" name="email" required 
                                   class="form-input w-full"
                                   placeholder="your@email.com">
                        </div>
                        
                        <button type="submit" id="loginBtn" class="btn-primary w-full py-3 px-6 rounded-lg text-white font-semibold">
                            <span id="loginBtnText">Войти</span>
                            <span id="loginBtnLoading" class="loading hidden"></span>
                        </button>
                    </form>
                    
                    <div class="mt-6 text-sm text-gray-600">
                        <p>Мы отправим ссылку для входа на ваш email</p>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="hidden max-w-4xl mx-auto fade-in">
                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Profile Info -->
                    <div class="md:col-span-1">
                        <div class="card rounded-xl p-6">
                            <div class="text-center mb-6">
                                <div class="w-24 h-24 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user text-3xl text-pink-600"></i>
                                </div>
                                <h3 id="userName" class="text-xl font-semibold text-gray-800">Загрузка...</h3>
                                <p id="userEmail" class="text-gray-600">loading@email.com</p>
                                <p id="userPhone" class="text-gray-600">+7 (___) ___-__-__</p>
                            </div>
                            
                            <button id="editProfileBtn" class="w-full py-2 px-4 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition mb-3">
                                Редактировать профиль
                            </button>
                            <button id="logoutBtn" class="w-full py-2 px-4 border border-pink-300 text-pink-600 rounded-lg hover:bg-pink-50 transition">
                                Выйти
                            </button>
                        </div>
                    </div>

                    <!-- Bookings -->
                    <div class="md:col-span-2">
                        <div class="card rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-semibold text-gray-800">Мои записи</h3>
                                <button id="newBookingBtn" class="btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                                    Новая запись
                                </button>
                            </div>
                            
                            <div id="bookingsList" class="space-y-4">
                                <!-- Bookings will be loaded here -->
                            </div>
                            
                            <div id="noBookings" class="hidden text-center py-12">
                                <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">У вас пока нет записей</p>
                                <button id="bookFirstBtn" class="btn-primary mt-4 py-2 px-6 rounded-lg text-white font-semibold">
                                    Записаться на услугу
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Booking Modal -->
            <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Новая запись</h3>
                            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form id="newBookingForm" class="space-y-4">
                            <div>
                                <label for="serviceSelect" class="block text-gray-700 font-medium mb-2">Услуга</label>
                                                                    <select id="serviceSelect" name="service" required 
                                            class="form-input w-full">
                                    <option value="">Выберите услугу</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="dateSelect" class="block text-gray-700 font-medium mb-2">Дата</label>
                                                                    <input type="date" id="dateSelect" name="date" required 
                                           class="form-input w-full">
                            </div>
                            
                            <div>
                                <label for="timeSelect" class="block text-gray-700 font-medium mb-2">Время</label>
                                                                    <select id="timeSelect" name="time" required 
                                            class="form-input w-full">
                                    <option value="">Выберите время</option>
                                </select>
                            </div>
                            
                            <div class="flex space-x-3 pt-4">
                                <button type="button" id="cancelBookingBtn" 
                                        class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                    Отмена
                                </button>
                                <button type="submit" class="flex-1 btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                                    Записаться
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Редактировать профиль</h3>
                    <button id="closeEditModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editProfileForm" class="space-y-4">
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <div id="profileImagePreview" class="w-24 h-24 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 overflow-hidden">
                                <i class="fas fa-user text-3xl text-pink-600" id="defaultProfileIcon"></i>
                                <img id="profileImage" class="w-full h-full object-cover hidden" alt="Фото профиля">
                            </div>
                            <button type="button" id="changePhotoBtn" class="absolute bottom-0 right-0 bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-pink-700 transition">
                                <i class="fas fa-camera text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label for="editFullName" class="block text-gray-700 font-medium mb-2">Имя</label>
                        <input type="text" id="editFullName" name="fullName" required 
                               class="form-input w-full" placeholder="Введите ваше имя">
                    </div>
                    
                    <div>
                        <label for="editPhone" class="block text-gray-700 font-medium mb-2">Телефон</label>
                        <input type="tel" id="editPhone" name="phone" 
                               class="form-input w-full" placeholder="+7 (___) ___-__-__">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelEditBtn" 
                                class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Отмена
                        </button>
                        <button type="submit" class="flex-1 btn-primary py-2 px-4 rounded-lg text-white font-semibold">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Photo Selection Modal -->
    <div id="photoSelectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Выберите фото профиля</h3>
                    <button id="closePhotoModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="customPhotoUpload" class="block text-gray-700 font-medium mb-2">Загрузить свое фото</label>
                        <input type="file" id="customPhotoUpload" name="photo" accept="image/*" 
                               class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Доступные изображения (аватары + иконки)</label>
                        <div id="standardPhotos" class="grid grid-cols-6 gap-2 max-h-60 overflow-y-auto">
                            <!-- Available images will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelPhotoBtn" 
                                class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Отмена
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Supabase configuration
        let supabase;
        let currentUser = null;

        // Initialize Supabase
        async function initSupabase() {
            try {
                console.log('=== НАЧАЛО ИНИЦИАЛИЗАЦИИ SUPABASE ===');
                
                // Проверяем, что Supabase SDK загружен
                console.log('Проверяем window.supabase:', typeof window.supabase);
                console.log('Проверяем глобальную переменную supabase:', typeof supabase);
                
                // Если SDK не найден, пробуем загрузить заново
                if (typeof window.supabase === 'undefined' && typeof supabase === 'undefined') {
                    console.log('SDK не найден, пробуем загрузить заново...');
                    await loadSupabase();
                    
                    // Проверяем снова
                    console.log('После повторной загрузки:');
                    console.log('- window.supabase:', typeof window.supabase);
                    console.log('- supabase:', typeof supabase);
                    
                    if (typeof window.supabase === 'undefined' && typeof supabase === 'undefined') {
                        throw new Error('Supabase SDK не загружен даже после повторной попытки');
                    }
                }
                
                // Используем доступный SDK
                const sdk = window.supabase || supabase;
                console.log('Используем SDK:', sdk);
                
                // Создаем клиент
                console.log('Создаем клиент Supabase...');
                const client = sdk.createClient(
                    'https://iaezefurqmmgubdgqakt.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhZXplZnVycW1tZ3ViZGdxYWt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTk3NjQsImV4cCI6MjA3MTUzNTc2NH0.-Puoiddwu_xIx9BaHM0BBfbsULdU0Ljzh6uQleVToBQ'
                );
                
                console.log('Клиент создан:', client);
                
                // Присваиваем глобальным переменным
                window.supabaseClient = client;
                supabaseClient = client;
                
                console.log('Глобальные переменные установлены:');
                console.log('- window.supabaseClient:', window.supabaseClient);
                console.log('- supabaseClient:', supabaseClient);
                
                // Check if user is already logged in
                console.log('Проверяем текущего пользователя...');
                const { data: { user } } = await client.auth.getUser();
                if (user) {
                    console.log('Пользователь найден:', user);
                    currentUser = user;
                    showProfile();
                    loadUserProfile();
                    loadBookings();
                    loadServices();
                } else {
                    console.log('Пользователь не найден, показываем форму входа');
                    showAuth();
                }
                
                // Проверяем сессию в URL (для Magic Link)
                const { data: { session } } = await client.auth.getSession();
                if (session) {
                    console.log('Сессия найдена в URL:', session);
                    currentUser = session.user;
                    showProfile();
                    loadUserProfile();
                    loadBookings();
                    loadServices();
                }
                
                console.log('=== ИНИЦИАЛИЗАЦИЯ SUPABASE ЗАВЕРШЕНА УСПЕШНО ===');
                
                // Настраиваем форму входа
                console.log('Настраиваем форму входа...');
                setupLoginForm();
                
                // Настраиваем обработчик изменения состояния аутентификации
                console.log('Настраиваем обработчик аутентификации...');
                setupAuthStateChange();
                
            } catch (error) {
                console.error('=== ОШИБКА ИНИЦИАЛИЗАЦИИ SUPABASE ===');
                console.error('Error initializing Supabase:', error);
                console.error('Stack trace:', error.stack);
                alert('Ошибка инициализации: ' + error.message);
            }
        }



        // Handle login form submission
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                console.log('Настраиваем форму входа...');
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Форма отправлена!');
                    
                    const email = document.getElementById('email').value;
                    const loginBtn = document.getElementById('loginBtn');
                    const loginBtnText = document.getElementById('loginBtnText');
                    const loginBtnLoading = document.getElementById('loginBtnLoading');
                    
                    try {
                        // Проверяем, что Supabase инициализирован
                        const client = window.supabaseClient || supabaseClient;
                        if (!client || !client.auth) {
                            throw new Error('Supabase не инициализирован. Попробуйте обновить страницу.');
                        }
                        
                        console.log('Используем Supabase клиент:', client);
                        console.log('Email для входа:', email);
                        
                        // Show loading state
                        loginBtn.disabled = true;
                        loginBtnText.classList.add('hidden');
                        loginBtnLoading.classList.remove('hidden');
                        
                        // Send magic link
                        const { error } = await client.auth.signInWithOtp({
                            email: email,
                            options: {
                                emailRedirectTo: 'https://svetsalonpro.ru/pages/account.html'
                            }
                        });
                        
                        if (error) throw error;
                        
                        // Show success message
                        alert('Ссылка для входа отправлена на ваш email!');
                        
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Ошибка входа: ' + error.message);
                    } finally {
                        // Reset button state
                        loginBtn.disabled = false;
                        loginBtnText.classList.remove('hidden');
                        loginBtnLoading.classList.add('hidden');
                    }
                });
                console.log('Форма входа настроена успешно!');
            } else {
                console.error('Форма входа не найдена!');
            }
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const client = window.supabaseClient || supabaseClient;
                await client.auth.signOut();
                currentUser = null;
                showAuth();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Show auth section
        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('hidden');
        }

        // Show profile section
        function showProfile() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
        }

        // Load user profile
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const client = window.supabaseClient || supabaseClient;
                const { data: profile, error } = await client
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (profile) {
                    document.getElementById('userName').textContent = profile.full_name || 'Пользователь';
                    document.getElementById('userEmail').textContent = profile.email || currentUser.email;
                    document.getElementById('userPhone').textContent = profile.phone || 'Не указан';
                } else {
                    // Create profile if doesn't exist
                    await createUserProfile();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Create user profile
        async function createUserProfile() {
            try {
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client
                    .from('profiles')
                    .insert({
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: currentUser.user_metadata?.full_name || 'Пользователь',
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Reload profile
                loadUserProfile();
            } catch (error) {
                console.error('Error creating profile:', error);
            }
        }

        // Load user bookings
        async function loadBookings() {
            if (!currentUser) return;
            
            try {
                const client = window.supabaseClient || supabaseClient;
                const { data: bookings, error } = await client
                    .from('bookings')
                    .select(`
                        *,
                        services(name, price),
                        slots(date, time)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                displayBookings(bookings || []);
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        // Display bookings
        function displayBookings(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            const noBookings = document.getElementById('noBookings');
            
            if (bookings.length === 0) {
                bookingsList.classList.add('hidden');
                noBookings.classList.remove('hidden');
                return;
            }
            
            bookingsList.classList.remove('hidden');
            noBookings.classList.add('hidden');
            
            bookingsList.innerHTML = bookings.map(booking => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${booking.services?.name || 'Услуга'}</h4>
                            <p class="text-gray-600 text-sm">${new Date(booking.slots?.date).toLocaleDateString('ru-RU')} в ${booking.slots?.time}</p>
                            <p class="text-gray-500 text-sm">Статус: ${getStatusText(booking.status)}</p>
                        </div>
                        <div class="flex space-x-2">
                            ${booking.status === 'confirmed' ? `
                                <button onclick="cancelBooking('${booking.id}')" 
                                        class="px-3 py-1 text-sm border border-red-300 text-red-600 rounded hover:bg-red-50 transition">
                                    Отменить
                                </button>
                                <button onclick="rescheduleBooking('${booking.id}')" 
                                        class="px-3 py-1 text-sm border border-blue-300 text-blue-600 rounded hover:bg-blue-50 transition">
                                    Перенести
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get status text
        function getStatusText(status) {
            const statuses = {
                'pending': 'Ожидает подтверждения',
                'confirmed': 'Подтверждено',
                'cancelled': 'Отменено',
                'completed': 'Завершено'
            };
            return statuses[status] || status;
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Вы уверены, что хотите отменить запись?')) return;
            
            try {
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client
                    .from('bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', bookingId);
                
                if (error) throw error;
                
                alert('Запись отменена');
                loadBookings();
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('Ошибка при отмене записи');
            }
        }

        // Reschedule booking
        function rescheduleBooking(bookingId) {
            alert('Функция переноса записи будет доступна в ближайшее время');
        }

        // Modal controls
        document.getElementById('newBookingBtn').addEventListener('click', () => {
            document.getElementById('bookingModal').classList.remove('hidden');
            loadServices();
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('bookingModal').classList.add('hidden');
        });

        document.getElementById('cancelBookingBtn').addEventListener('click', () => {
            document.getElementById('bookingModal').classList.add('hidden');
        });

        // Load services for booking
        async function loadServices() {
            try {
                const client = window.supabaseClient || supabaseClient;
                const { data: services, error } = await client
                    .from('services')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                const serviceSelect = document.getElementById('serviceSelect');
                serviceSelect.innerHTML = '<option value="">Выберите услугу</option>' +
                    services.map(service => `<option value="${service.id}">${service.name} - ${service.price}₽</option>`).join('');
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        // Handle new booking form
        document.getElementById('newBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const serviceId = formData.get('service');
            const date = formData.get('date');
            const time = formData.get('time');
            
            try {
                const client = window.supabaseClient || supabaseClient;
                
                // Create slot
                const { data: slot, error: slotError } = await client
                    .from('slots')
                    .insert({
                        date: date,
                        time: time,
                        available: false
                    })
                    .select()
                    .single();
                
                if (slotError) throw slotError;
                
                // Create booking
                const { error: bookingError } = await client
                    .from('bookings')
                    .insert({
                        user_id: currentUser.id,
                        service_id: serviceId,
                        slot_id: slot.id,
                        status: 'pending'
                    });
                
                if (bookingError) throw bookingError;
                
                alert('Запись создана! Ожидайте подтверждения от администратора.');
                document.getElementById('bookingModal').classList.add('hidden');
                e.target.reset();
                loadBookings();
                
            } catch (error) {
                console.error('Error creating booking:', error);
                alert('Ошибка при создании записи: ' + error.message);
            }
        });

        // Initialize date and time inputs
        function initializeDateTimeInputs() {
            const dateInput = document.getElementById('dateSelect');
            const timeSelect = document.getElementById('timeSelect');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Generate time slots
            const timeSlots = [];
            for (let hour = 9; hour <= 20; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                if (hour < 20) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
            }
            
            timeSelect.innerHTML = '<option value="">Выберите время</option>' +
                timeSlots.map(time => `<option value="${time}">${time}</option>`).join('');
        }

        // Mobile menu functionality
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const mobileMenu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                mobileMenu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            
            if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                mobileMenu.classList.add('hidden');
                const icon = document.querySelector('#mobileMenuBtn i');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
            setupAuthStateChange();
            initializeDateTimeInputs();
            loadAvailableImages();
        });



        // Edit Profile Modal
        document.getElementById('editProfileBtn').addEventListener('click', () => {
            const modal = document.getElementById('editProfileModal');
            const fullNameInput = document.getElementById('editFullName');
            const phoneInput = document.getElementById('editPhone');
            
            // Fill current values
            fullNameInput.value = document.getElementById('userName').textContent;
            phoneInput.value = document.getElementById('userPhone').textContent === 'Не указан' ? '' : document.getElementById('userPhone').textContent;
            
            modal.classList.remove('hidden');
        });

        // Close Edit Profile Modal
        document.getElementById('closeEditModalBtn').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.add('hidden');
        });

        // Cancel Edit Profile
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.add('hidden');
        });

        // Change Photo Button
        document.getElementById('changePhotoBtn').addEventListener('click', () => {
            document.getElementById('photoSelectionModal').classList.remove('hidden');
        });

        // Close Photo Selection Modal
        document.getElementById('closePhotoModalBtn').addEventListener('click', () => {
            document.getElementById('photoSelectionModal').classList.add('hidden');
        });

        // Cancel Photo Selection
        document.getElementById('cancelPhotoBtn').addEventListener('click', () => {
            document.getElementById('photoSelectionModal').classList.add('hidden');
        });

        // Handle Edit Profile Form
        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('editFullName').value;
            const phone = document.getElementById('editPhone').value;
            
            try {
                const client = window.supabaseClient || supabaseClient;
                const { error } = await client
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        phone: phone || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // Update UI
                document.getElementById('userName').textContent = fullName;
                document.getElementById('userPhone').textContent = phone || 'Не указан';
                
                // Close modal
                document.getElementById('editProfileModal').classList.add('hidden');
                
                alert('Профиль обновлен!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Ошибка при обновлении профиля: ' + error.message);
            }
        });

        // Handle Custom Photo Upload
        document.getElementById('customPhotoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const profileImage = document.getElementById('profileImage');
                    const defaultIcon = document.getElementById('defaultProfileIcon');
                    
                    profileImage.src = e.target.result;
                    profileImage.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    
                    // Update main profile image
                    const mainProfileImage = document.querySelector('#profileSection #profileImagePreview img');
                    if (mainProfileImage) {
                        mainProfileImage.src = e.target.result;
                        mainProfileImage.classList.remove('hidden');
                    }
                    
                    // Close photo selection modal
                    document.getElementById('photoSelectionModal').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Load Standard Photos and Icons
        async function loadStandardPhotos() {
            try {
                const client = window.supabaseClient || supabaseClient;
                
                // Список стандартных аватарок (если есть)
                const standardPhotos = [];
                for (let i = 1; i <= 30; i++) {
                    standardPhotos.push(`/images/profile-photos/avatar${i}.jpg`);
                }
                
                // Список иконок из папки ico (поддерживаемые форматы)
                const iconFiles = [
                    '/images/ico/icon1.png',
                    '/images/ico/icon2.png',
                    '/images/ico/icon3.png',
                    '/images/ico/icon4.png',
                    '/images/ico/icon5.png',
                    '/images/ico/icon6.png',
                    '/images/ico/icon7.png',
                    '/images/ico/icon8.png',
                    '/images/ico/icon9.png',
                    '/images/ico/icon10.png',
                    '/images/ico/icon11.png',
                    '/images/ico/icon12.png',
                    '/images/ico/icon13.png',
                    '/images/ico/icon14.png',
                    '/images/ico/icon15.png',
                    '/images/ico/icon16.png',
                    '/images/ico/icon17.png',
                    '/images/ico/icon18.png',
                    '/images/ico/icon19.png',
                    '/images/ico/icon20.png',
                    '/images/ico/icon21.png',
                    '/images/ico/icon22.png',
                    '/images/ico/icon23.png',
                    '/images/ico/icon24.png',
                    '/images/ico/icon25.png',
                    '/images/ico/icon26.png',
                    '/images/ico/icon27.png',
                    '/images/ico/icon28.png',
                    '/images/ico/icon29.png',
                    '/images/ico/icon30.png'
                ];
                
                // Объединяем все доступные изображения
                const allImages = [...standardPhotos, ...iconFiles];
                
                const container = document.getElementById('standardPhotos');
                container.innerHTML = allImages.map((image, index) => `
                    <div class="cursor-pointer hover:opacity-75 transition" onclick="selectStandardPhoto('${image}', index)">
                        <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center overflow-hidden">
                            <img src="${image}" alt="Изображение ${index + 1}" class="w-full h-full object-cover" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <i class="fas fa-user text-pink-600" style="display: none;"></i>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading standard photos:', error);
            }
        }

        // Select Standard Photo
        function selectStandardPhoto(photoPath, index) {
            try {
                // Обновляем фото профиля
                const profileImage = document.getElementById('profileImage');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                
                profileImage.src = photoPath;
                profileImage.classList.remove('hidden');
                defaultIcon.classList.add('hidden');
                
                // Обновляем основное фото профиля
                const mainProfileImage = document.querySelector('#profileSection #profileImagePreview img');
                if (mainProfileImage) {
                    mainProfileImage.src = photoPath;
                    mainProfileImage.classList.remove('hidden');
                } else {
                    // Создаем изображение если его нет
                    const newImg = document.createElement('img');
                    newImg.src = photoPath;
                    newImg.alt = 'Фото профиля';
                    newImg.className = 'w-full h-full object-cover';
                    document.querySelector('#profileSection #profileImagePreview').appendChild(newImg);
                }
                
                // Скрываем иконку по умолчанию в основном профиле
                const mainDefaultIcon = document.querySelector('#profileSection #profileImagePreview i');
                if (mainDefaultIcon) {
                    mainDefaultIcon.classList.add('hidden');
                }
                
                // Закрываем модальное окно
                document.getElementById('photoSelectionModal').classList.add('hidden');
                
                alert(`Выбрана аватарка ${index + 1}!`);
                
            } catch (error) {
                console.error('Error selecting standard photo:', error);
                alert('Ошибка при выборе аватарки: ' + error.message);
            }
        }

        // Setup auth state change listener
        function setupAuthStateChange() {
            const client = window.supabaseClient || supabaseClient;
            if (client) {
                console.log('Настраиваем отслеживание состояния аутентификации...');
                client.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event, session);
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        showProfile();
                        loadUserProfile();
                        loadBookings();
                        loadServices();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        showAuth();
                    }
                });
            } else {
                console.error('Supabase клиент не найден для настройки auth state change');
            }
        }

    </script>
</body>
</html>
