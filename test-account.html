<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 10px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .endpoint-list {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }
        .endpoint-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }
        .endpoint-item h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #111827;
        }
        .endpoint-description {
            margin: 0 0 12px 0;
            color: #4b5563;
            font-size: 14px;
        }
        .endpoint-item .status {
            margin: 0;
        }
        .endpoint-meta {
            margin-top: 8px;
            font-size: 12px;
            color: #6b7280;
        }
        #logs {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</h1>
        
        <div class="status info">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞.
        </div>
        
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:</h2>
        <div id="status" class="status info">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å</div>
        
        <h2>–°—Å—ã–ª–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>
        <a href="pages/account.html" class="button">üì± –û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="index.html" class="button">üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:</h2>
        <div id="serverStatus" class="status info">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å</div>

        <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API:</h2>
        <div id="apiStatus" class="endpoint-list"></div>

        <h2>–õ–æ–≥–∏:</h2>
        <div id="logs" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
    </div>

    <script>
        const monitorEmail = 'monitoring+healthcheck@svetsalonpro.ru';
        const endpointStatusElements = new Map();
        const endpointMetaElements = new Map();
        const CHECK_INTERVAL = 30000;

        const endpointChecks = [
            {
                id: 'portfolio',
                name: 'GET /api/portfolio-photos.js',
                description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–¥–∞—á–∏ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ',
                method: 'GET',
                url: '/api/portfolio-photos.js',
                allowedStatuses: [200],
                headers: { 'Accept': 'application/json' },
                formatSuccess: ({ json }) => {
                    if (json && typeof json === 'object') {
                        const categories = Object.keys(json);
                        if (categories.length) {
                            return `API –æ—Ç–≤–µ—á–∞–µ—Ç, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${categories.join(', ')}`;
                        }
                        return 'API –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
                    }
                    return 'API –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –¥–∞–Ω–Ω—ã–µ –∏–º–µ—é—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç';
                }
            },
            {
                id: 'upload-photos',
                name: 'GET /api/upload-photos.js',
                description: '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π',
                method: 'GET',
                url: '/api/upload-photos.js',
                allowedStatuses: [200],
                headers: { 'Accept': 'application/json' },
                formatSuccess: ({ json }) => {
                    const count = json && Array.isArray(json.photos) ? json.photos.length : 0;
                    return `API –æ—Ç–≤–µ—á–∞–µ—Ç, –∑–∞–ø–∏—Å–µ–π: ${count}`;
                }
            },
            {
                id: 'send-sms',
                name: 'POST /api/send-sms-code.js',
                description: '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ SMS-–∫–æ–¥–∞ –Ω–∞ —Å–ª—É–∂–µ–±–Ω—ã–π email',
                method: 'POST',
                url: '/api/send-sms-code.js',
                allowedStatuses: [200],
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: () => ({ email: monitorEmail }),
                formatSuccess: ({ json }) => {
                    if (json && json.success) {
                        return '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ';
                    }
                    return '–û—Ç–≤–µ—Ç 200, –Ω–æ —Ñ–ª–∞–≥ success –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                }
            },
            {
                id: 'verify-sms',
                name: 'POST /api/verify-sms-code.js',
                description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ SMS-–∫–æ–¥–∞',
                method: 'POST',
                url: '/api/verify-sms-code.js',
                allowedStatuses: [200, 400],
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: () => ({ email: monitorEmail, code: '0000' }),
                formatSuccess: ({ status, json }) => {
                    if (status === 200) {
                        return '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω —Å–µ—Ä–≤–µ—Ä–æ–º';
                    }
                    const errorText = json && json.error ? json.error : '—Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª –æ–± –æ—à–∏–±–∫–µ';
                    return `–ü–æ–ª—É—á–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞: ${errorText}`;
                }
            }
        ];

        let isCheckingEndpoints = false;

        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function setStatus(elementId, state, message) {
            const element = document.getElementById(elementId);
            if (!element) {
                return;
            }
            element.className = `status ${state}`;
            element.textContent = message;
        }

        function renderEndpointList() {
            const container = document.getElementById('apiStatus');
            container.innerHTML = '';

            endpointChecks.forEach(endpoint => {
                const item = document.createElement('div');
                item.className = 'endpoint-item';

                const title = document.createElement('h3');
                title.textContent = endpoint.name;

                const description = document.createElement('p');
                description.className = 'endpoint-description';
                description.textContent = endpoint.description;

                const statusElement = document.createElement('div');
                statusElement.className = 'status info';
                statusElement.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...';

                const metaElement = document.createElement('div');
                metaElement.className = 'endpoint-meta';
                metaElement.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å';

                item.appendChild(title);
                item.appendChild(description);
                item.appendChild(statusElement);
                item.appendChild(metaElement);
                container.appendChild(item);

                endpointStatusElements.set(endpoint.id, statusElement);
                endpointMetaElements.set(endpoint.id, metaElement);
            });
        }

        function updateEndpointStatus(id, state, message, metaText) {
            const statusElement = endpointStatusElements.get(id);
            if (statusElement) {
                statusElement.className = `status ${state}`;
                statusElement.textContent = message;
            }

            const metaElement = endpointMetaElements.get(id);
            if (metaElement && metaText) {
                metaElement.textContent = metaText;
            }
        }

        async function runEndpointCheck(endpoint) {
            const startTime = new Date().toLocaleTimeString();
            updateEndpointStatus(endpoint.id, 'pending', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...', `–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ ${startTime}`);
            log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º ${endpoint.name}...`);

            try {
                const headers = Object.assign({}, endpoint.headers || {});
                headers['Cache-Control'] = 'no-cache';

                const options = {
                    method: endpoint.method,
                    headers,
                    cache: 'no-store'
                };

                const payload = typeof endpoint.body === 'function' ? endpoint.body() : endpoint.body;
                if (payload) {
                    options.body = JSON.stringify(payload);
                }

                const response = await fetch(endpoint.url, options);
                const status = response.status;
                const statusText = response.statusText;
                const contentType = response.headers.get('content-type') || '';
                const rawText = await response.text();

                let parsedJson = null;
                if (rawText && contentType.includes('application/json')) {
                    try {
                        parsedJson = JSON.parse(rawText);
                    } catch (parseError) {
                        log(`‚ö†Ô∏è ${endpoint.name}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON (${parseError.message})`);
                    }
                }

                const context = { status, statusText, json: parsedJson, rawText };
                const allowedStatuses = endpoint.allowedStatuses || [200];
                const statusIsAllowed = allowedStatuses.includes(status);
                const timestamp = new Date().toLocaleTimeString();
                const meta = `HTTP ${status}${statusText ? ` ${statusText}` : ''} ¬∑ ${timestamp}`;

                if (statusIsAllowed) {
                    const message = endpoint.formatSuccess ? endpoint.formatSuccess(context) : `–û—Ç–≤–µ—Ç ${status}`;
                    updateEndpointStatus(endpoint.id, 'success', `‚úÖ ${message}`, meta);
                    log(`‚úÖ ${endpoint.name}: ${message}`);
                } else {
                    const message = endpoint.formatError ? endpoint.formatError(context) : `–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å ${status}`;
                    updateEndpointStatus(endpoint.id, 'error', `‚ùå ${message}`, meta);
                    log(`‚ùå ${endpoint.name}: ${message}`);
                    if (rawText) {
                        log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${rawText.substring(0, 200)}`);
                    }
                }
            } catch (error) {
                const meta = `–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${new Date().toLocaleTimeString()}`;
                updateEndpointStatus(endpoint.id, 'error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, meta);
                log(`‚ùå ${endpoint.name}: ${error.message}`);
            }
        }

        async function runEndpointChecks() {
            if (isCheckingEndpoints) {
                log('‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É API: –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
                return;
            }

            isCheckingEndpoints = true;

            try {
                for (const endpoint of endpointChecks) {
                    await runEndpointCheck(endpoint);
                }
            } finally {
                isCheckingEndpoints = false;
            }
        }

        function checkServer() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä...');
            setStatus('serverStatus', 'pending', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞...');

            fetch('/pages/account.html', { cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        setStatus('serverStatus', 'success', '‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                        log('‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ account.html –¥–æ—Å—Ç—É–ø–Ω–∞');
                    } else {
                        setStatus('serverStatus', 'error', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                        log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                    }
                })
                .catch(error => {
                    setStatus('serverStatus', 'error', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
                });
        }

        function checkPageLoad() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            setStatus('status', 'pending', '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç...');

            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'pages/account.html';
            iframe.setAttribute('aria-hidden', 'true');

            iframe.onload = function() {
                setStatus('status', 'success', '‚úÖ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω');
                log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ account.html –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ');
                iframe.remove();
            };

            iframe.onerror = function() {
                setStatus('status', 'error', '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞');
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã account.html');
                iframe.remove();
            };

            document.body.appendChild(iframe);
        }

        window.addEventListener('load', () => {
            renderEndpointList();
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...');
            log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ ${CHECK_INTERVAL / 1000} —Å–µ–∫—É–Ω–¥`);
            setStatus('status', 'pending', '‚è≥ –ì–æ—Ç–æ–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞...');
            setStatus('serverStatus', 'pending', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞...');
            checkServer();
            setTimeout(checkPageLoad, 1000);
            runEndpointChecks();

            setInterval(() => {
                checkServer();
                runEndpointChecks();
            }, CHECK_INTERVAL);
        });
    </script>
</body>
</html>
